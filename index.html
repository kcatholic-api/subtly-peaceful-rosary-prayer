
<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="생각보다 은근히 평안한 묵주 기도 도우미">
    <!--<meta name="author" content="">-->
    <title>생각보다 은근히 평안한 묵주 기도 도우미</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="rosary-canvas.js"></script>

    <link rel="icon" href="favicon.ico">

    <style>
      .prayer-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        grid-template-rows: minmax(0, 8fr) auto auto;
        grid-template-areas:
          "top top"
          "pane pane"
          "options nav";
        min-height: calc(100vh - 160px);
        gap: 0.5rem;
      }
      .prayer-pane-top {
        grid-area: top;
        min-height: 0;
        color: #f8f9fa;
      }
      .prayer-pane-top .prayer-metadata h3 {
        color: #f1ede7;
      }
      .prayer-pane-top .prayer-metadata .text-muted {
        color: rgba(241, 237, 231, 0.8) !important;
      }
      .prayer-pane-bottom {
        grid-area: pane;
      }
      .prayer-controls-options {
        grid-area: options;
        display: flex;
        justify-content: flex-start;
        align-items: flex-end;
      }
      .prayer-controls-nav {
        grid-area: nav;
        display: flex;
        justify-content: flex-end;
        align-items: flex-end;
        gap: 0.75rem;
      }
      .prayer-layout.horizontal-split {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        grid-template-rows: minmax(0, 1fr) auto;
        grid-template-areas:
          "top pane"
          "nav pane";
        align-items: stretch;
      }
      .prayer-layout.horizontal-split .prayer-pane-bottom {
        grid-column: 2;
        grid-row: 1 / span 2;
        align-self: start;
        justify-self: stretch;
        height: calc(100% - 6.5rem);
        margin-top: 3rem;
        margin-bottom: 0;
        padding-bottom: 6.5rem;
      }
      .prayer-layout.horizontal-split .prayer-pane-top {
        height: 100%;
        min-height: 0;
      }
      .prayer-layout.horizontal-split .prayer-controls-options {
        grid-area: top;
        align-self: end;
        justify-self: start;
        margin: 0 0 0rem 0rem;
      }
      .prayer-layout.horizontal-split .prayer-controls-nav {
        grid-area: nav;
        align-self: end;
        justify-self: end;
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        margin: 0;
        z-index: 1200;
      }
      .prayer-pane-bottom {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 0.75rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 140px;
        position: relative;
      }
      .prayer-line-button {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        padding: 0;
      }
      .prayer-lyric-area {
        flex: 1 1 auto;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        text-align: center;
      }
      .prayer-step-title {
        text-align: left;
      }
      .prayer-step-body {
        flex: 1 1 auto;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .prayer-step-text {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        align-items: center;
      }
      .prayer-line {
        margin: 0;
        line-height: 1.4;
        white-space: pre-wrap;
        max-width: 100%;
      }
      .prayer-line-current {
        position: relative;
        display: inline-block;
        max-width: 100%;
        --prayer-karaoke-progress: 0%;
        --prayer-karaoke-transition: 0.18s;
        --prayer-karaoke-highlight: #0d6efd;
        --prayer-karaoke-base: #212529;
        color: var(--prayer-karaoke-base);
      }
      .prayer-line-current.karaoke-armed {
        --prayer-karaoke-base: rgba(33, 37, 41, 0.35);
      }
      .prayer-line-current .karaoke-char {
        color: var(--prayer-karaoke-base);
        transition: color var(--prayer-karaoke-transition, 0.18s) linear;
        white-space: inherit;
      }
      .prayer-line-current .karaoke-char.karaoke-char-highlighted {
        color: var(--prayer-karaoke-highlight);
      }
      .prayer-line-adjacent {
        color: rgba(108, 117, 125, 0.6);
        font-size: 0.9rem;
        white-space: pre-wrap;
      }
      .prayer-options-overlay {
        width: min(320px, calc(100vw - 2rem));
        max-width: 320px;
      }
      .prayer-options-container {
        position: relative;
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
      .prayer-options-container .prayer-options-overlay {
        position: absolute;
        bottom: calc(100% + 0.75rem);
        left: 0;
        z-index: 1100;
      }
      .prayer-options-overlay #plannerOptionsWrapper {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: 1px solid #dee2e6;
      }
      .prayer-options-overlay #plannerOptions {
        border-top: none;
      }
      .prayer-options-toggle-button {
        background-color: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
        padding: 0.5rem 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        white-space: nowrap;
        font-weight: 600;
        color: #212529;
      }
      .prayer-options-toggle-button.active {
        border-color: rgba(13, 110, 253, 0.6);
        box-shadow: 0 0.5rem 1.5rem rgba(13, 110, 253, 0.15);
      }
      .prayer-options-toggle-button:focus-visible {
        outline: 2px solid rgba(13, 110, 253, 0.6);
        outline-offset: 2px;
      }
      #prayerOptionsOverlay .prayer-overlay-active .border-top {
        border-top-width: 0;
      }
      body.prayer-mode {
        overflow: hidden;
        height: 100dvh;
        min-height: 100dvh;
      }
      body.prayer-mode main.container-fluid {
        padding: 0;
        height: 100dvh;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
      }
      body.prayer-mode #plannerView {
        display: none !important;
      }
      body.prayer-mode #prayerView {
        flex: 1 1 auto;
        display: flex !important;
        flex-direction: column;
        position: fixed;
        inset: 0;
        padding: 1rem;
        height: auto;
        background-color: #1f0b0bff;
        overflow: hidden;
        z-index: 1000;
      }
      body.prayer-mode .prayer-layout {
        flex: 1 1 auto;
        min-height: 0;
        height: 100%;
        grid-template-rows: minmax(0, 8fr) auto auto;
      }
      body.prayer-mode .prayer-layout.horizontal-split {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        grid-template-rows: minmax(0, 1fr) auto;
      }
      body.prayer-mode .prayer-pane-top {
        min-height: 0;
      }
      body.prayer-mode .prayer-pane-bottom {
        min-height: 140px;
      }
      .prayer-exit-button {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 1200;
      }
      body.prayer-mode #notice_div,
      body.prayer-mode #error_div,
      body.prayer-mode #mdrow {
        display: none !important;
      }
      @media (max-width: 767.98px) {
        .prayer-layout {
          min-height: 100%;
        }
        body.prayer-mode .prayer-layout {
          height: 100%;
          min-height: 100%;
        }
        .prayer-pane-top {
          min-height: 240px;
        }
        body.prayer-mode #prayerView {
          padding: 0.5rem;
          padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0px));
        }
        .prayer-exit-button {
          top: 0.5rem;
          right: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4" id="mainNavbar">
  <div class="container-fluid">
    <a class="navbar-brand" href="" id="menu_title">묵주 기도 도우미</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#" onclick="load_record()">나의 기록</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- First Modal -->
<div class="modal fade" id="startupModal" tabindex="-1" aria-labelledby="startupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="startupModalLabel"><small><i>생각보다 은근히 평안한</i></small><br/>묵주 기도 도우미</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
        평화를 빕니다!
        </p>
        <p>
        이 웹사이트는 어려운 가톨릭 묵주 기도를 생각보다 편리하고 평안한 기분으로 시도해 볼 수 있는 기능을 제공하여 전 세계 한인 가톨릭 공동체의 형제자매님들께 도움이 되고자 만들어졌습니다.
        </p>
        <small>
        이 웹사이트는 <b>데스크톱</b> 브라우저 환경에 최적화되어 있습니다. 혹시! 모바일에서 열어보셨다면 <i>생각보다 은근히</i> 불편하실 수 있으니, 집에 돌아가신 후 컴퓨터로 다시 방문하시길 권해드립니다.
        </small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="never_see_startup()">다시 보지 않기</button>
      </div>
    </div>
  </div>
</div>

<!-- Load Modal -->
<div class="modal fade" id="loadModal" tabindex="-1" aria-labelledby="loadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="loadModalLabel">로컬 브라우저 저장소 불러오기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>어떻게 작동 하나요?</small> <a id="readMore3" data-bs-toggle="collapse" href="#moreText3" aria-expanded="false" aria-controls="moreText3"><small>자세히</small></a></small>
          <span id="moreText3" class="collapse"><br/><small>편집기로 작성 중인 Markdown 문서에서 Heading 1 (#) 또는 Heading 2 (##) 가 적용된 문자열을 추출해서 문서 제목으로 간주 합니다. 이 제목을 Key로 정하고 웹 표준 기술인 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API" target="_blank">Web Storage API</a>을 이용하여 전체 Markdown 데이타를 사용중인 디바이스의 웹브라우저에 저장하고 불러 옵니다. 따라서 서버에는 그 어떤 정보도 저장되지 않습니다.</small><br/>
          <small>로컬 브라우저 저장소는 어떤 이유에서건 사라질 수 있습니다. 작성하신 문서는 다운로드 기능을 사용하여 Markdown (확장자.md) 파일로 직접 안전하게 저장해 두시는 것을 권장합니다.</small></span>
        </p>
        <div class="list-group" id="saved">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid">
  <div class="row ms-1 me-1">
    <div id="notice_div" class="alert alert-primary" role="alert" style="display: none"></div>
    <div id="error_div" class="alert alert-danger" role="alert" style="display: none"></div>
  </div>
  <div id="plannerView">
    <div class="row justify-content-center mb-4">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="card-title text-center mb-4">오늘의 묵주 기도</h2>
            <p class="text-center text-secondary mb-2">오늘 함께 바칠 신비를 선택해 보세요.</p>
            <p class="text-center text-muted small mb-4">월·토 환희 | 화·금 고통 | 수·일 영광 | 목요일 빛의 신비</p>
            <div class="row gy-3">
              <div class="col-12 col-sm-6">
                <div class="form-check border rounded p-3 h-100 d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" value="환의의 신비" id="plannerJoyful">
                    <label class="form-check-label fw-semibold mb-0" for="plannerJoyful">
                      환의의 신비
                    </label>
                  </div>
                  <select class="form-select form-select-sm w-auto text-center" id="plannerJoyfulCount" aria-label="환의의 신비 단수 선택" disabled>
                    <option value="1">1단</option>
                    <option value="2">2단</option>
                    <option value="3">3단</option>
                    <option value="4">4단</option>
                    <option value="5" selected>5단</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="form-check border rounded p-3 h-100 d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" value="고통의 신비" id="plannerSorrowful">
                    <label class="form-check-label fw-semibold mb-0" for="plannerSorrowful">
                      고통의 신비
                    </label>
                  </div>
                  <select class="form-select form-select-sm w-auto text-center" id="plannerSorrowfulCount" aria-label="고통의 신비 단수 선택" disabled>
                    <option value="1">1단</option>
                    <option value="2">2단</option>
                    <option value="3">3단</option>
                    <option value="4">4단</option>
                    <option value="5" selected>5단</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="form-check border rounded p-3 h-100 d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" value="영광의 신비" id="plannerGlorious">
                    <label class="form-check-label fw-semibold mb-0" for="plannerGlorious">
                      영광의 신비
                    </label>
                  </div>
                  <select class="form-select form-select-sm w-auto text-center" id="plannerGloriousCount" aria-label="영광의 신비 단수 선택" disabled>
                    <option value="1">1단</option>
                    <option value="2">2단</option>
                    <option value="3">3단</option>
                    <option value="4">4단</option>
                    <option value="5" selected>5단</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="form-check border rounded p-3 h-100 d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" value="빛의 신비" id="plannerLuminous">
                    <label class="form-check-label fw-semibold mb-0" for="plannerLuminous">
                      빛의 신비
                    </label>
                  </div>
                  <select class="form-select form-select-sm w-auto text-center" id="plannerLuminousCount" aria-label="빛의 신비 단수 선택" disabled>
                    <option value="1">1단</option>
                    <option value="2">2단</option>
                    <option value="3">3단</option>
                    <option value="4">4단</option>
                    <option value="5" selected>5단</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mt-4" id="plannerOptionsHome">
              <div class="border rounded" id="plannerOptionsWrapper">
                <button class="w-100 bg-transparent border-0 px-3 py-3 d-flex align-items-center justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#plannerOptions" aria-expanded="false" aria-controls="plannerOptions">
                  <span class="fw-semibold">옵션</span>
                  <i class="bi bi-chevron-down" aria-hidden="true" id="plannerOptionsToggleIcon"></i>
                </button>
                <div class="collapse" id="plannerOptions">
                  <div class="border-top px-3 pb-3 pt-3">
                    <div class="form-check form-switch mt-2">
                      <input class="form-check-input" type="checkbox" role="switch" id="plannerOptionTts">
                      <label class="form-check-label" for="plannerOptionTts">TTS로 읽어 주기</label>
                    </div>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="plannerOptionAutoProgress">
                    <label class="form-check-label" for="plannerOptionAutoProgress">자동으로 진행 하기</label>
                  </div>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="plannerOptionVoiceAuto" disabled>
                    <label class="form-check-label d-flex align-items-center" for="plannerOptionVoiceAuto">
                      음성 인식으로 자동 진행 하기
                      <span class="badge bg-secondary ms-2">실험 기능</span>
                    </label>
                  </div>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="plannerOptionFullscreen">
                    <label class="form-check-label" for="plannerOptionFullscreen">전체 화면으로 보기</label>
                  </div>
                  <div id="prayerViewOptions" class="d-none">
                    <hr/>
                    <button type="button" class="btn btn-sm btn-secondary" id="rosaryLayoutResetButton">묵주 레이아웃 초기화</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
            <div class="d-grid mt-4">
              <button type="button" class="btn btn-primary btn-lg py-3" id="plannerStartButton" disabled>시작</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="prayerView" class="d-none">
    <button type="button" class="btn btn-secondary btn-sm prayer-exit-button" id="prayerExitButton" aria-label="플래너로 돌아가기">
      <i class="bi bi-x-lg"></i>
    </button>
    <div class="prayer-layout">
      <div class="prayer-pane-top position-relative">
        <canvas id="rosary-canvas" style="width:100%;height:100%"></canvas>
        <div class="prayer-metadata position-absolute top-0 start-0 m-3">
          <div class="d-flex align-items-baseline flex-wrap gap-2">
            <h3 class="fw-bold mb-0" id="prayerCurrentMystery">환의의 신비</h3>
            <div class="fw-semibold fs-5 text-muted" id="prayerCurrentDecade">1단</div>
          </div>
        </div>
      </div>
      <div class="prayer-pane-bottom">
        <div class="prayer-metadata position-absolute top-0 start-0 m-3">
          <p class="text-secondary fw-semibold mb-3" id="prayerCurrentStepTitle">기도문 제목</p>
        </div>
        <button type="button" class="btn btn-secondary btn-sm prayer-line-button position-absolute top-0 end-0 m-3" id="prayerLinePrevButton" aria-label="이전 줄">▲</button>
        <div class="prayer-lyric-area px-4 py-4">
          <div class="prayer-step-body w-100">
            <div class="prayer-step-text text-center w-100" id="prayerCurrentStepContent" role="presentation"></div>
          </div>
        </div>
        <button type="button" class="btn btn-primary btn-sm prayer-line-button position-absolute bottom-0 end-0 m-3" id="prayerLineNextButton" aria-label="다음 줄">▼</button>
      </div>
      <div class="prayer-controls-options">
        <div class="prayer-options-container">
          <div id="prayerOptionsOverlay" class="prayer-options-overlay d-none" aria-hidden="true"></div>
          <button type="button" class="btn prayer-options-toggle-button btn-sm d-inline-flex align-items-center gap-2" id="prayerOptionsToggleButton" aria-expanded="false" aria-controls="prayerOptionsOverlay">
            <span class="fw-semibold">옵션</span>
            <i class="bi bi-chevron-up" id="prayerOptionsToggleCaret" aria-hidden="true"></i>
          </button>
        </div>
      </div>
      <div class="prayer-controls-nav">
        <button type="button" class="btn btn-secondary" id="prayerPrevButton">
          이전
        </button>
        <button type="button" class="btn btn-primary" id="prayerNextButton">
          다음
        </button>
      </div>
    </div>
  </div>
  <div id="mdrow" class="row">
  </div>
</main>
  <footer style="text-align: center" class="pt-2" id="mainFooter">
    <p class="fs-6"><small>평화를 빕니다! <a href="https://kcatholic-api.github.io/" target="_blank">한국어 가톨릭 API 프로젝트</a>를 방문하여 보세요.</small></p>
  </footer>
  </body>

<script>
function show_catch_phrase() {
  $("#menu_title").text("생각보다 은근히 평안한").fadeIn(500).delay(5000).fadeOut(500, show_menu_title);
}
function show_menu_title(fade=true) {
  if(fade)
    $("#menu_title").text("묵주 기도 도우미").fadeIn(500).delay(25000).fadeOut(500, show_catch_phrase);
  else
    $("#menu_title").text("묵주 기도 도우미").delay(25000).fadeOut(500, show_catch_phrase);
}

var startup_dialog_version = "kcatolic-api-sprp-startup-message-v1";
function never_see_startup() {
  localStorage.setItem(startup_dialog_version, "no");
}

function load_record() {
}

const plannerMysteryControls = [
  { checkbox: "#plannerJoyful", select: "#plannerJoyfulCount" },
  { checkbox: "#plannerSorrowful", select: "#plannerSorrowfulCount" },
  { checkbox: "#plannerGlorious", select: "#plannerGloriousCount" },
  { checkbox: "#plannerLuminous", select: "#plannerLuminousCount" }
];
const plannerCheckboxSelector = plannerMysteryControls.map((control) => control.checkbox).join(", ");
const settingsPrefix = "kcatolic-api-sprp-settings.";
let voiceAutoPreference = false;
let prayerSequence = [];
let prayerSequenceIndex = 0;
let prayerLineIndex = 0;
let lineByLineEnabled = true;
let ttsEnabled = false;
let prayerStepIdCounter = 0;
let rosaryLayoutRefreshHandle = null;
let autoProgressEnabled = false;
let autoProgressTimeoutHandle = null;
const AUTO_PROGRESS_LINE_DELAY_MS = 0;
const AUTO_PROGRESS_STEP_DELAY_MS = 100;
const HORIZONTAL_SPLIT_ASPECT_THRESHOLD = 16 / 10;
const ttsState = {
  supported: typeof window !== "undefined" && typeof window.speechSynthesis !== "undefined" && typeof window.SpeechSynthesisUtterance !== "undefined",
  voices: [],
  preferredVoice: null,
  utterance: null,
  currentToken: null,
  karaokeElement: null,
  progressRAF: null,
  textLength: 0,
  startTime: 0,
  lastBoundaryTime: 0,
  lastBoundaryIndex: 0,
  charsPerSecond: 12,
  expectingCancel: false,
  isChrome: false,
  pendingRequest: null
};
let ttsSupportAlerted = false;

const rosaryPrayerTexts = {
  apostlesCreed: "╋ 전능하신 천주 성부, ◎ 천지의 창조주를 저는 믿나이다.\n그 외아들 우리 주 예수 그리스도님,\n성령으로 인하여 동정 마리아께 잉태되어 나시고,\n본시오 빌라도 통치 아래에서 고난을 받으시고,\n십자가에 못 박혀 돌아가시고 묻히셨으며,\n저승에 가시어 사흗날에 죽은 이들 가운데서 부활하시고,\n하늘에 올라 전능하신 천주 성부 오른편에 앉아 계시며,\n그리로부터 산 이와 죽은 이를 심판하러 오시리라 믿나이다.\n성령을 믿으며,\n거룩하고 보편된 교회와 모든 성인의 통공을 믿으며,\n죄의 용서와 육신의 부활을 믿으며,\n영원한 삶을 믿나이다. 아멘.",
  ourFather: "◎ 하늘에 계신 우리 아버지,\n아버지의 이름이 거룩히 빛나시며\n아버지의 나라가 오시며\n아버지의 뜻이 하늘에서와 같이 땅에서도 이루어지소서.\n오늘 저희에게 일용할 양식을 주시고\n저희에게 잘못한 이를 저희가 용서하오니\n저희 죄를 용서하시고\n저희를 유혹에 빠지지 않게 하시고\n악에서 구하소서. 아멘.",
  hailMary: "○ 은총이 가득하신 마리아님, 기뻐하소서.\n주님께서 함께 계시니 여인 중에 복되시며\n태중의 아들 예수님 또한 복되시나이다.\n● 천주의 성모 마리아님,\n이제와 저희 죽을 때에 저희 죄인을 위하여 빌어주소서. ◎ 아멘.",
  gloryBe: "영광이 성부와 성자와 성령께,\n처음과 같이 이제와 항상 영원히. 아멘.",
  fatimaPrayer: "예수님, 저희 죄를 용서하시며,\n저희를 지옥 불에서 구하시고\n연옥영혼을 돌보시며\n가장 버림받은 영혼을 돌보소서.\n아멘.",
  hailHolyQueen: "천상 모후, 사랑이 불타는 어머니,\n우리의 생명, 기쁨, 희망이시여!\n당신 우러러 하와의 그 자손들,\n눈물의 골짜기에서 통곡하며 부르짖나이다.\n우리들의 보호자 성모님,\n불쌍한 저희를 인자로운 눈으로 굽어보소서.\n귀양살이 끝날 때에 당신의 지극히 사랑하올\n아들 예수를 저희에게 보이소서.\n너그러우시고, 자애로우시며,\n오 아름다우신 동정 마리아님.\n천주의 성모님,\n저희를 위하여 빌어주시어\n그리스도께서 약속하신 영원한 생명을 얻게 하소서. 아멘."
};

const rosaryMysteryData = {
  "#plannerJoyful": {
    key: "joyful",
    title: "환의의 신비",
    decades: [
      { label: "1단", meditation: "마리아께서 예수님을 잉태하심을 묵상합시다." },
      { label: "2단", meditation: "마리아께서 엘리사벳을 찾아보심을 묵상합시다." },
      { label: "3단", meditation: "마리아께서 예수님을 낳으심을 묵상합시다." },
      { label: "4단", meditation: "마리아께서 예수님을 성전에 바치심을 묵상합시다." },
      { label: "5단", meditation: "마리아께서 잃으셨던 예수님을 성전에서 찾으심을 묵상합시다." }
    ]
  },
  "#plannerSorrowful": {
    key: "sorrowful",
    title: "고통의 신비",
    decades: [
      { label: "1단", meditation: "예수님께서 우리를 위하여 피땀 흘리심을 묵상합시다." },
      { label: "2단", meditation: "예수님께서 우리를 위하여 매맞으심을 묵상합시다." },
      { label: "3단", meditation: "예수님께서 우리를 위하여 가시관 쓰심을 묵상합시다." },
      { label: "4단", meditation: "예수님께서 우리를 위하여 십자가 지심을 묵상합시다." },
      { label: "5단", meditation: "예수님께서 우리를 위하여 십자가에 못박혀 돌아가심을 묵상합시다." }
    ]
  },
  "#plannerGlorious": {
    key: "glorious",
    title: "영광의 신비",
    decades: [
      { label: "1단", meditation: "예수님께서 부활하심을 묵상합시다." },
      { label: "2단", meditation: "예수님께서 승천하심을 묵상합시다." },
      { label: "3단", meditation: "예수님께서 성령을 보내심을 묵상합시다." },
      { label: "4단", meditation: "예수님께서 마리아를 하늘에 불러올리심을 묵상합시다." },
      { label: "5단", meditation: "예수님께서 마리아께 천상 모후의 관을 씌우심을 묵상합시다." }
    ]
  },
  "#plannerLuminous": {
    key: "luminous",
    title: "빛의 신비",
    decades: [
      { label: "1단", meditation: "예수님께서 세례받으심을 묵상합시다." },
      { label: "2단", meditation: "예수님께서 카나에서 첫 기적을 행하심을 묵상합시다." },
      { label: "3단", meditation: "예수님께서 하느님 나라를 선포하심을 묵상합시다." },
      { label: "4단", meditation: "예수님께서 거룩하게 변모하심을 묵상합시다." },
      { label: "5단", meditation: "예수님께서 성체성사를 세우심을 묵상합시다." }
    ]
  }
};

function create_intro_steps() {
  return [
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "준비",
      content: "(성호경 및 십자가의 예수님 발에 입맞춤)",
      highlight: 'cross'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "사도신경",
      content: rosaryPrayerTexts.apostlesCreed,
      highlight: 'cross'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "주님의 기도",
      content: rosaryPrayerTexts.ourFather,
      highlight: 'intro-0'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "성모송 (1/3)",
      content: rosaryPrayerTexts.hailMary,
      highlight: 'intro-1'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "성모송 (2/3)",
      content: rosaryPrayerTexts.hailMary,
      highlight: 'intro-2'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "성모송 (3/3)",
      content: rosaryPrayerTexts.hailMary,
      highlight: 'intro-3'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "영광송",
      content: rosaryPrayerTexts.gloryBe,
      highlight: 'intro-4'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "구원을 위한 기도",
      content: rosaryPrayerTexts.fatimaPrayer,
      highlight: 'intro-4'
    }
  ];
}

function create_concluding_steps() {
  return [
    {
      type: "conclusion",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "성모찬송",
      content: rosaryPrayerTexts.hailHolyQueen,
      highlight: 'medal'
    },
    {
      type: "conclusion",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "마무리",
      content: "(성호경 및 십자가의 예수님 발에 입맞춤)",
      highlight: 'cross'
    }
  ];
}

function create_decade_steps({ mysteryTitle, decadeIndex, decadeLabel, meditation, hailMaryCount }) {
  const steps = [];
  var pater_highlight = 'pater-'+(decadeIndex-1);
  if (decadeIndex == 0)
    pater_highlight = 'medal';
  steps.push({
    type: "meditation",
    mysteryTitle,
    decadeLabel,
    title: `${decadeLabel} 묵상`,
    content: meditation,
    highlight: pater_highlight
  });
  steps.push({
    type: "prayer",
    mysteryTitle,
    decadeLabel,
    title: "주님의 기도",
    content: rosaryPrayerTexts.ourFather,
    highlight: pater_highlight
  });
  for (let i = 1; i <= hailMaryCount; i += 1) {
    steps.push({
      type: "prayer",
      mysteryTitle,
      decadeLabel,
      title: "성모송",
      content: rosaryPrayerTexts.hailMary,
      highlight: 'ave-'+decadeIndex+'-'+(i-1),
      progressLabel: `${i}/${hailMaryCount}`
    });
  }
  pater_highlight = 'pater-'+(decadeIndex);
  if((decadeIndex+1) == 5)
    pater_highlight = 'medal';
  steps.push({
    type: "prayer",
    mysteryTitle,
    decadeLabel,
    title: "영광송",
    content: rosaryPrayerTexts.gloryBe,
    highlight: pater_highlight
  });
  steps.push({
    type: "prayer",
    mysteryTitle,
    decadeLabel,
    title: "구원의 기도",
    content: rosaryPrayerTexts.fatimaPrayer,
    highlight: pater_highlight
  });
  return steps;
}

function build_prayer_sequence() {
  prayerStepIdCounter = 0;
  const sequence = create_intro_steps();
  plannerMysteryControls.forEach(({ checkbox, select }) => {
    const checkboxElement = $(checkbox);
    const selectElement = $(select);
    const data = rosaryMysteryData[checkbox];
    if (!checkboxElement.length || !checkboxElement.is(":checked") || !data) {
      return;
    }
    const requestedCount = parseInt(selectElement.val(), 10) || data.decades.length;
    const effectiveCount = Math.min(requestedCount, data.decades.length);
    for (let index = 0; index < effectiveCount; index += 1) {
      const decade = data.decades[index];
      sequence.push(...create_decade_steps({
        mysteryTitle: data.title,
        decadeIndex: index,
        decadeLabel: decade.label,
        meditation: decade.meditation,
        hailMaryCount: 10
      }));
    }
  });
  sequence.push(...create_concluding_steps());
  return sequence.map((step) => {
    prayerStepIdCounter += 1;
    const prefix = step.type || "step";
    return {
      ...step,
      stepId: `${prefix}-${prayerStepIdCounter}`
    };
  });
}

function get_step_lines(step) {
  if (!step) {
    return [""];
  }
  const rawContent = typeof step.content === "string" ? step.content : "";
  if (!step._lineCache || step._lineCache.source !== rawContent) {
    const lines = rawContent
      .split(/\r?\n/)
      .map((line) => line.trim())
      .filter((line) => line.length > 0);
    step._lineCache = {
      source: rawContent,
      lines: lines.length ? lines : [""]
    };
  }
  return step._lineCache.lines;
}

function render_prayer_navigation_state() {
  const hasSequence = prayerSequence.length > 0;
  const currentStep = hasSequence ? prayerSequence[prayerSequenceIndex] : null;
  const stepLines = currentStep ? get_step_lines(currentStep) : [""];
  const hasPrevLine = hasSequence && prayerLineIndex > 0;
  const hasNextLine = hasSequence && prayerLineIndex < stepLines.length - 1;
  const hasNextStep = hasSequence && prayerSequenceIndex < prayerSequence.length - 1;
  const hasPrevStep = prayerSequenceIndex > 0;
  const nextButton = $("#prayerNextButton");
  const prevButton = $("#prayerPrevButton");
  const linePrevButton = $("#prayerLinePrevButton");
  const lineNextButton = $("#prayerLineNextButton");
  const hideLineControls = !lineByLineEnabled;
  if (nextButton.length) {
    if (!hasSequence) {
      nextButton.prop("disabled", true).text("다음");
    } else if (hasNextStep) {
      nextButton.prop("disabled", false).text("다음");
    } else {
      nextButton.prop("disabled", true).text("완료");
    }
  }
  if (prevButton.length) {
    //prevButton.text("이전 단계");
    if (!hasSequence || !hasPrevStep) {
      prevButton.prop("disabled", true);
    } else {
      prevButton.prop("disabled", false);
    }
  }
  if (linePrevButton.length) {
    linePrevButton.toggleClass("d-none", hideLineControls);
    linePrevButton.prop("disabled", hideLineControls || !hasSequence || !hasPrevLine);
  }
  if (lineNextButton.length) {
    lineNextButton.toggleClass("d-none", hideLineControls);
    lineNextButton.prop("disabled", hideLineControls || !hasSequence || !hasNextLine);
  }
}

function create_prayer_line_element(text, role = "adjacent") {
  const safeText = typeof text === "string" ? text.replace(/\r\n/g, "\n") : "";
  const line = $("<div>").addClass("prayer-line");
  if (role === "current") {
    line.addClass("prayer-line-current");
    build_karaoke_markup(line, safeText);
  } else {
    line.addClass("prayer-line-adjacent").text(safeText);
    line.attr("data-text-length", safeText.length);
  }
  return line;
}

function build_karaoke_markup(line, text) {
  if (!line || !line.length) {
    return [];
  }
  const element = line.get(0);
  if (!element) {
    return [];
  }
  const safeText = typeof text === "string" ? text.replace(/\r\n/g, "\n") : "";
  const fragment = document.createDocumentFragment();
  const graphemes = Array.from(safeText);
  const charNodes = [];
  line.empty();
  graphemes.forEach((char) => {
    if (char === "\n") {
      fragment.appendChild(document.createElement("br"));
      return;
    }
    const span = document.createElement("span");
    span.className = "karaoke-char";
    span.textContent = char;
    fragment.appendChild(span);
    charNodes.push(span);
  });
  element.appendChild(fragment);
  line.attr("data-raw-text", safeText);
  line.attr("data-text-length", charNodes.length);
  line.data("karaokeChars", charNodes);
  line.data("karaokeThresholds", compute_karaoke_thresholds(safeText, charNodes));
  line.data("karaokeHighlightedCount", 0);
  return charNodes;
}

function ensure_karaoke_markup(line) {
  if (!line || !line.length) {
    return [];
  }
  const existing = line.data("karaokeChars");
  if (Array.isArray(existing)) {
    const thresholds = line.data("karaokeThresholds");
    if (!Array.isArray(thresholds) || thresholds.length !== existing.length) {
      const fallbackText = (line.attr("data-raw-text") || line.text() || "").replace(/\r\n/g, "\n");
      line.data("karaokeThresholds", compute_karaoke_thresholds(fallbackText, existing));
    }
    return existing;
  }
  const fallbackText = (line.attr("data-raw-text") || line.text() || "").replace(/\r\n/g, "\n");
  return build_karaoke_markup(line, fallbackText);
}

function reset_karaoke_highlight(line) {
  if (!line || !line.length) {
    return;
  }
  const chars = ensure_karaoke_markup(line);
  for (let i = 0; i < chars.length; i += 1) {
    const node = chars[i];
    if (node && node.classList) {
      node.classList.remove("karaoke-char-highlighted");
    }
  }
  line.data("karaokeHighlightedCount", 0);
}

function compute_karaoke_thresholds(originalText, charNodes) {
  if (!Array.isArray(charNodes) || !charNodes.length) {
    return [];
  }
  const sanitized = sanitize_prayer_text_for_tts(originalText || "");
  const sanitizedChars = Array.from(sanitized);
  const sanitizedLength = sanitizedChars.length;
  if (!sanitizedLength) {
    return new Array(charNodes.length).fill(1);
  }
  const thresholds = new Array(charNodes.length).fill(1);
  const removalPattern = /[╋◎○●]/;
  const isWhitespace = (char) => /\s/.test(char);
  let nodeIndex = 0;
  sanitizedChars.forEach((sChar, sIndex) => {
    if (sChar === " ") {
      while (nodeIndex < charNodes.length) {
        const node = charNodes[nodeIndex];
        const nodeChar = node && node.textContent ? node.textContent : "";
        if (!isWhitespace(nodeChar)) {
          break;
        }
        thresholds[nodeIndex] = (sIndex + 1) / sanitizedLength;
        nodeIndex += 1;
      }
      return;
    }
    while (nodeIndex < charNodes.length) {
      const node = charNodes[nodeIndex];
      const nodeChar = node && node.textContent ? node.textContent : "";
      if (isWhitespace(nodeChar)) {
        thresholds[nodeIndex] = sanitizedLength ? sIndex / sanitizedLength : 0;
        nodeIndex += 1;
        continue;
      }
      if (nodeChar === sChar) {
        thresholds[nodeIndex] = (sIndex + 1) / sanitizedLength;
        nodeIndex += 1;
        break;
      }
      if (removalPattern.test(nodeChar)) {
        thresholds[nodeIndex] = sanitizedLength ? sIndex / sanitizedLength : 0;
      } else {
        thresholds[nodeIndex] = (sIndex + 1) / sanitizedLength;
      }
      nodeIndex += 1;
    }
  });
  while (nodeIndex < charNodes.length) {
    thresholds[nodeIndex] = 1;
    nodeIndex += 1;
  }
  return thresholds;
}

function get_current_karaoke_element() {
  return $("#prayerCurrentStepContent .prayer-line-current").first();
}

function reset_karaoke_visual_state() {
  const lines = $("#prayerCurrentStepContent .prayer-line-current");
  lines.each(function() {
    const $line = $(this);
    this.style.setProperty("--prayer-karaoke-progress", "0%");
    this.style.removeProperty("--prayer-karaoke-transition");
    this.classList.remove("karaoke-armed", "karaoke-active", "karaoke-complete");
    reset_karaoke_highlight($line);
  });
  if (ttsState) {
    ttsState.karaokeElement = lines.length ? lines.eq(0) : null;
  }
}

function get_current_prayer_text_for_tts() {
  if (!prayerSequence.length) {
    return "";
  }
  const step = prayerSequence[prayerSequenceIndex];
  if (!step) {
    return "";
  }
  const rawContent = typeof step.content === "string" ? step.content : "";
  if (lineByLineEnabled) {
    const lines = get_step_lines(step);
    if (!lines.length) {
      return rawContent;
    }
    const currentIndex = Math.max(0, Math.min(prayerLineIndex, lines.length - 1));
    return lines[currentIndex] || "";
  }
  return rawContent;
}

function sanitize_prayer_text_for_tts(rawText) {
  if (typeof rawText !== "string") {
    return "";
  }
  return rawText.replace(/[╋◎○●]/g, "").replace(/\s+/g, " ").trim();
}
function is_parenthetical_line(rawText) {
  if (typeof rawText !== "string") {
    return false;
  }
  const trimmed = rawText.trim();
  if (!trimmed.startsWith("(") || !trimmed.endsWith(")")) {
    return false;
  }
  const inner = trimmed.slice(1, -1).trim();
  return inner.length > 0;
}


function get_current_tts_token() {
  if (!prayerSequence.length) {
    return "idle";
  }
  const step = prayerSequence[prayerSequenceIndex];
  if (!step) {
    return "idle";
  }
  const stepId = step.stepId || `step-${prayerSequenceIndex}`;
  const lineToken = lineByLineEnabled ? `line-${prayerLineIndex}` : "full";
  return `${stepId}:${lineToken}`;
}

function handle_tts_after_render() {
  clear_auto_progress_timer();
  if (!ttsEnabled) {
    stop_tts({ cancelSpeech: true, resetKaraoke: true });
    ttsState.currentToken = null;
    return;
  }
  if (!$("body").hasClass("prayer-mode")) {
    stop_tts({ cancelSpeech: true, resetKaraoke: true });
    ttsState.currentToken = null;
    return;
  }
  if (!ttsState.supported) {
    if (!ttsSupportAlerted) {
      show_tts_support_warning();
    }
    return;
  }
  const token = get_current_tts_token();
  const rawText = get_current_prayer_text_for_tts();
  if (is_parenthetical_line(rawText)) {
    stop_tts({ cancelSpeech: true, resetKaraoke: true });
    ttsState.currentToken = null;
    schedule_parenthetical_step_skip();
    return;
  }
  const text = sanitize_prayer_text_for_tts(rawText);
  if (!text) {
    stop_tts({ cancelSpeech: true, resetKaraoke: true });
    ttsState.currentToken = null;
    return;
  }
  const currentLine = get_current_karaoke_element();
  if (currentLine.length) {
    ttsState.karaokeElement = currentLine;
  }
  if (ttsState.currentToken === token && typeof window !== "undefined" && window.speechSynthesis && window.speechSynthesis.speaking) {
    return;
  }
  ttsState.currentToken = token;
  stop_tts({ cancelSpeech: true, resetKaraoke: true });
  start_tts_for_text(text, token);
}

function start_tts_for_text(text, token) {
  if (!ttsState.supported) {
    return;
  }
  const cleanText = (text || "").trim();
  if (!cleanText) {
    return;
  }
  const voice = get_preferred_tts_voice();
  if (!voice && (!ttsState.voices || !ttsState.voices.length)) {
    ttsState.pendingRequest = { text: cleanText, token: token || null };
    if (typeof window !== "undefined" && window.speechSynthesis) {
      window.speechSynthesis.getVoices();
    }
    return;
  }
  ttsState.pendingRequest = null;
  const utterance = new SpeechSynthesisUtterance(cleanText);
  utterance.lang = "ko-KR";
  if (voice) {
    utterance.voice = voice;
  }
  utterance.rate = 1;
  utterance.pitch = 1;
  utterance.onstart = handle_tts_start;
  utterance.onend = handle_tts_end;
  utterance.onerror = handle_tts_error;
  utterance.onboundary = handle_tts_boundary;
  ttsState.utterance = utterance;
  ttsState.textLength = cleanText.length;
  ttsState.expectingCancel = false;
  if (typeof window !== "undefined" && window.speechSynthesis) {
    window.speechSynthesis.cancel();
    window.setTimeout(() => {
      if (window.speechSynthesis) {
        try {
          window.speechSynthesis.speak(utterance);
        } catch (error) {
          console.warn("TTS 실행에 실패했습니다.", error);
        }
      }
    }, 0);
  }
}

function stop_tts(options = {}) {
  const { cancelSpeech = false, resetKaraoke = false } = options;
  if (resetKaraoke) {
    clear_karaoke_visual();
  }
  clear_auto_progress_timer();
  if (!ttsState.supported) {
    return;
  }
  stop_karaoke_loop();
  if (ttsState.utterance) {
    ttsState.utterance.onstart = null;
    ttsState.utterance.onend = null;
    ttsState.utterance.onerror = null;
    ttsState.utterance.onboundary = null;
    ttsState.utterance = null;
  }
  if (cancelSpeech && typeof window !== "undefined" && window.speechSynthesis) {
    if (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
      ttsState.expectingCancel = true;
      window.speechSynthesis.cancel();
    }
  }
}

function handle_tts_start() {
  clear_auto_progress_timer();
  const line = get_current_karaoke_element();
  if (line.length) {
    ttsState.karaokeElement = line;
    prepare_karaoke_element(line, { reset: true });
    line.addClass("karaoke-armed");
    set_karaoke_progress(line, 0);
  }
  ttsState.startTime = performance.now();
  ttsState.lastBoundaryTime = ttsState.startTime;
  ttsState.lastBoundaryIndex = 0;
  const baseCharsPerSecond = lineByLineEnabled
    ? Math.max(6, Math.min(18, ttsState.textLength / 3 || 12))
    : Math.max(4, Math.min(8, ttsState.textLength / 9 || 6.5));
  ttsState.charsPerSecond = baseCharsPerSecond;
  start_karaoke_loop();
}

function handle_tts_end() {
  const completed = !ttsState.expectingCancel;
  finalize_karaoke(completed);
  stop_karaoke_loop();
  ttsState.utterance = null;
  ttsState.expectingCancel = false;
  if (ttsState.pendingRequest) {
    const pending = { ...ttsState.pendingRequest };
    ttsState.pendingRequest = null;
    if (!pending.token || pending.token === ttsState.currentToken) {
      start_tts_for_text(pending.text, pending.token || ttsState.currentToken);
    }
  }
  if (completed) {
    auto_advance_after_tts();
  }
}

function handle_tts_error() {
  finalize_karaoke(false);
  stop_karaoke_loop();
  ttsState.utterance = null;
  ttsState.expectingCancel = false;
}

function handle_tts_boundary(event) {
  if (!event || typeof event.charIndex !== "number") {
    return;
  }
  const now = performance.now();
  const previousIndex = ttsState.lastBoundaryIndex;
  const newIndex = Math.max(event.charIndex, previousIndex);
  const deltaChars = newIndex - previousIndex;
  const deltaTime = (now - ttsState.lastBoundaryTime) / 1000;
  if (deltaChars > 0 && deltaTime > 0.01) {
    const cps = deltaChars / deltaTime;
    ttsState.charsPerSecond = (ttsState.charsPerSecond * 0.6) + (cps * 0.4);
  }
  ttsState.lastBoundaryIndex = newIndex;
  ttsState.lastBoundaryTime = now;
  const ratio = ttsState.textLength > 0 ? Math.min(newIndex / ttsState.textLength, 1) : 1;
  apply_karaoke_progress(ratio, 0.12);
}

function prepare_karaoke_element(line, options = {}) {
  if (!line || !line.length) {
    return;
  }
  const { reset = false } = options;
  ensure_karaoke_markup(line);
  if (reset) {
    line.removeClass("karaoke-armed karaoke-active karaoke-complete");
    line.get(0).style.setProperty("--prayer-karaoke-progress", "0%");
    line.get(0).style.removeProperty("--prayer-karaoke-transition");
    reset_karaoke_highlight(line);
  }
}

function set_karaoke_progress(line, ratio) {
  if (!line || !line.length) {
    return;
  }
  const element = line.get(0);
  const chars = ensure_karaoke_markup(line);
  const clamped = Math.max(0, Math.min(1, ratio));
  const total = chars.length;
  const previous = line.data("karaokeHighlightedCount") || 0;
  let target = 0;
  const thresholds = line.data("karaokeThresholds");
  if (total && Array.isArray(thresholds) && thresholds.length === total) {
    const epsilon = 0.00001;
    while (target < total && clamped + epsilon >= thresholds[target]) {
      target += 1;
    }
  } else {
    target = total ? Math.round(clamped * total) : 0;
  }
  if (target !== previous) {
    if (target > previous) {
      for (let i = previous; i < target; i += 1) {
        const node = chars[i];
        if (node && node.classList) {
          node.classList.add("karaoke-char-highlighted");
        }
      }
    } else {
      for (let i = target; i < previous; i += 1) {
        const node = chars[i];
        if (node && node.classList) {
          node.classList.remove("karaoke-char-highlighted");
        }
      }
    }
    line.data("karaokeHighlightedCount", target);
  }
  element.style.setProperty("--prayer-karaoke-progress", `${(clamped * 100).toFixed(2)}%`);
}

function apply_karaoke_progress(ratio, transitionSeconds) {
  const line = ttsState.karaokeElement;
  if (!line || !line.length) {
    return;
  }
  if (typeof transitionSeconds === "number") {
    line.get(0).style.setProperty("--prayer-karaoke-transition", `${transitionSeconds}s`);
  }
  set_karaoke_progress(line, ratio);
}

function start_karaoke_loop() {
  stop_karaoke_loop();
  if (!ttsState.karaokeElement || !ttsState.karaokeElement.length) {
    return;
  }
  ttsState.karaokeElement.addClass("karaoke-active");
  const tick = () => {
    const line = ttsState.karaokeElement;
    if (!line || !line.length) {
      ttsState.progressRAF = null;
      return;
    }
    const now = performance.now();
    const elapsed = (now - ttsState.lastBoundaryTime) / 1000;
    const projectedIndex = ttsState.lastBoundaryIndex + elapsed * ttsState.charsPerSecond;
    const ratio = ttsState.textLength > 0 ? Math.min(projectedIndex / ttsState.textLength, 1) : 1;
    apply_karaoke_progress(ratio, 0.1);
    if (ratio >= 1) {
      ttsState.progressRAF = null;
      return;
    }
    ttsState.progressRAF = requestAnimationFrame(tick);
  };
  ttsState.progressRAF = requestAnimationFrame(tick);
}

function stop_karaoke_loop() {
  if (ttsState.progressRAF) {
    cancelAnimationFrame(ttsState.progressRAF);
    ttsState.progressRAF = null;
  }
  if (ttsState.karaokeElement && ttsState.karaokeElement.length) {
    ttsState.karaokeElement.removeClass("karaoke-active");
  }
}

function finalize_karaoke(completed) {
  const line = ttsState.karaokeElement;
  if (!line || !line.length) {
    return;
  }
  if (completed) {
    set_karaoke_progress(line, 1);
    line.removeClass("karaoke-active").addClass("karaoke-armed karaoke-complete");
  } else {
    line.removeClass("karaoke-active karaoke-armed karaoke-complete");
    line.get(0).style.setProperty("--prayer-karaoke-progress", "0%");
    reset_karaoke_highlight(line);
  }
}

function clear_karaoke_visual() {
  const currentLines = $("#prayerCurrentStepContent .prayer-line-current");
  currentLines.each(function() {
    const $line = $(this);
    this.style.setProperty("--prayer-karaoke-progress", "0%");
    this.style.removeProperty("--prayer-karaoke-transition");
    this.classList.remove("karaoke-armed", "karaoke-active", "karaoke-complete");
    reset_karaoke_highlight($line);
  });
  ttsState.karaokeElement = currentLines.length ? currentLines.eq(0) : null;
}

function clear_auto_progress_timer() {
  if (autoProgressTimeoutHandle) {
    clearTimeout(autoProgressTimeoutHandle);
    autoProgressTimeoutHandle = null;
  }
}

function auto_advance_after_tts() {
  if (!autoProgressEnabled || !ttsEnabled) {
    return;
  }
  if (!$('body').hasClass('prayer-mode')) {
    return;
  }
  if (!prayerSequence.length) {
    return;
  }
  clear_auto_progress_timer();
  const schedule = (callback, delay) => {
    autoProgressTimeoutHandle = setTimeout(() => {
      autoProgressTimeoutHandle = null;
      callback();
    }, delay);
  };
  const step = prayerSequence[prayerSequenceIndex];
  if (!step) {
    return;
  }
  if (lineByLineEnabled) {
    const lines = get_step_lines(step);
    if (prayerLineIndex < lines.length - 1) {
      schedule(() => advance_prayer_line(), AUTO_PROGRESS_LINE_DELAY_MS);
      return;
    }
  }
  if (prayerSequenceIndex < prayerSequence.length - 1) {
    schedule(() => advance_prayer_step(), AUTO_PROGRESS_STEP_DELAY_MS);
  }
}

function schedule_parenthetical_step_skip() {
  if (!prayerSequence.length) {
    return;
  }
  clear_auto_progress_timer();
  if (prayerSequenceIndex >= prayerSequence.length - 1) {
    return;
  }
  autoProgressTimeoutHandle = setTimeout(() => {
    autoProgressTimeoutHandle = null;
    advance_prayer_step();
  }, 3000);
}

function init_tts_engine() {
  if (!ttsState.supported || typeof window === "undefined") {
    return;
  }
  const ua = navigator.userAgent || "";
  ttsState.isChrome = /Chrome\//.test(ua) && !/Edg\//.test(ua) && !/OPR\//.test(ua);
  const populateVoices = () => {
    if (!window.speechSynthesis) {
      return;
    }
    const voices = window.speechSynthesis.getVoices();
    if (!voices || !voices.length) {
      return;
    }
    ttsState.voices = voices;
    ttsState.preferredVoice = select_preferred_tts_voice();
    if (ttsState.pendingRequest && ttsEnabled && $("body").hasClass("prayer-mode")) {
      const pending = { ...ttsState.pendingRequest };
      ttsState.pendingRequest = null;
      start_tts_for_text(pending.text);
    }
  };
  populateVoices();
  if (typeof window.speechSynthesis.onvoiceschanged === "function") {
    const original = window.speechSynthesis.onvoiceschanged;
    window.speechSynthesis.onvoiceschanged = function() {
      populateVoices();
      if (typeof original === "function") {
        original();
      }
    };
  } else if (window.speechSynthesis.addEventListener) {
    window.speechSynthesis.addEventListener("voiceschanged", populateVoices);
  }
}

function select_preferred_tts_voice() {
  if (!ttsState.voices || !ttsState.voices.length) {
    return null;
  }
  const voices = ttsState.voices;
  const koreanVoices = voices.filter((voice) => {
    const lang = (voice.lang || "").toLowerCase();
    return lang.startsWith("ko");
  });
  if (ttsState.isChrome) {
    const chromePreferred = koreanVoices.find((voice) => /google/i.test(voice.name));
    if (chromePreferred) {
      return chromePreferred;
    }
  }
  const yunaVoice = koreanVoices.find((voice) => /yuna/i.test(voice.name));
  if (yunaVoice) {
    return yunaVoice;
  }
  if (koreanVoices.length) {
    return koreanVoices[0];
  }
  return voices[0] || null;
}

function get_preferred_tts_voice() {
  if (!ttsState.voices || !ttsState.voices.length) {
    return null;
  }
  if (!ttsState.preferredVoice) {
    ttsState.preferredVoice = select_preferred_tts_voice();
  }
  return ttsState.preferredVoice;
}

function handle_tts_enabled_change() {
  if (!ttsEnabled) {
    stop_tts({ cancelSpeech: true, resetKaraoke: true });
    ttsState.pendingRequest = null;
    ttsState.currentToken = null;
    return;
  }
  if (!ttsState.supported) {
    show_tts_support_warning();
    ttsEnabled = false;
    $("#plannerOptionTts").prop("checked", false);
    writeSetting("option.tts", false);
    return;
  }
  if ($("body").hasClass("prayer-mode")) {
    handle_tts_after_render();
  }
}

function show_tts_support_warning() {
  ttsSupportAlerted = true;
  const message = "현재 사용중인 브라우저에서는 음성 안내 기능(TTS)을 사용할 수 없습니다.";
  if (typeof window !== "undefined") {
    alert(message);
  } else {
    console.warn(message);
  }
}

function render_prayer_step() {
  const contentElement = $("#prayerCurrentStepContent");
  if (!contentElement.length) {
    render_prayer_navigation_state();
    return;
  }
  contentElement.empty();
  reset_karaoke_visual_state();
  if (!prayerSequence.length) {
    $("#prayerCurrentMystery").text("묵주 기도");
    $("#prayerCurrentDecade").text("");
    $("#prayerCurrentStepTitle").text("기도문");
    contentElement.append(create_prayer_line_element("묵주 기도를 시작하려면 단수를 선택해 주세요.", "current"));
    prayerLineIndex = 0;
    handle_tts_after_render();
    render_prayer_navigation_state();
    return;
  }
  const step = prayerSequence[prayerSequenceIndex];
  const rawContent = typeof step.content === "string" ? step.content : "";
  const lines = get_step_lines(step);
  $("#prayerCurrentMystery").text(step.mysteryTitle || "묵주 기도");
  $("#prayerCurrentDecade").text(step.decadeLabel || "");
  const titleText = step.progressLabel ? `${step.title} (${step.progressLabel})` : step.title;
  $("#prayerCurrentStepTitle").text(titleText);
  if (lineByLineEnabled) {
    if (prayerLineIndex >= lines.length) {
      prayerLineIndex = 0;
    }
    const currentIndex = Math.max(0, Math.min(prayerLineIndex, lines.length - 1));
    const nextIndex = currentIndex < lines.length - 1 ? currentIndex + 1 : null;
    contentElement.append(create_prayer_line_element(lines[currentIndex], "current"));
    if (nextIndex !== null) {
      contentElement.append(create_prayer_line_element(lines[nextIndex], "adjacent"));
    }
  } else {
    prayerLineIndex = 0;
    contentElement.append(create_prayer_line_element(rawContent, "current"));
  }
  if (step.stepId) {
    if(window.rosary)
      window.rosary.highlight_rosary_step(step.highlight || 'none');
  }
  handle_tts_after_render();
  render_prayer_navigation_state();
}

function apply_line_by_line_mode(enabled, options = {}) {
  const { triggerRender = true, allowAutoAdjust = true } = options;
  const next = !!enabled;
  const prev = lineByLineEnabled;
  if (prev === next) {
    update_voice_auto_option();
    if (triggerRender) {
      render_prayer_navigation_state();
    }
    return;
  }
  lineByLineEnabled = next;
  if (!lineByLineEnabled) {
    prayerLineIndex = 0;
  }
  if (allowAutoAdjust && !prev && lineByLineEnabled) {
    const autoProgressCheckbox = $("#plannerOptionAutoProgress");
    if (autoProgressCheckbox.length && !autoProgressCheckbox.is(":checked")) {
      autoProgressCheckbox.prop("checked", true);
      writeSetting("option.autoProgress", true);
      autoProgressEnabled = true;
    }
  }
  update_voice_auto_option();
  if (triggerRender) {
    render_prayer_step();
  } else {
    render_prayer_navigation_state();
  }
}

function is_landscape_orientation() {
  if (typeof window === "undefined") {
    return false;
  }
  return window.innerWidth > window.innerHeight;
}

function get_viewport_aspect_ratio() {
  if (typeof window === "undefined") {
    return 1;
  }
  const height = Math.max(window.innerHeight, 1);
  return window.innerWidth / height;
}

function should_use_horizontal_split() {
  if (!is_landscape_orientation()) {
    return false;
  }
  return get_viewport_aspect_ratio() >= HORIZONTAL_SPLIT_ASPECT_THRESHOLD;
}

function apply_horizontal_split_layout(options = {}) {
  const { triggerRender = true, allowAutoAdjust = true } = options;
  const shouldSplit = should_use_horizontal_split();
  const layout = $(".prayer-layout");
  if (layout.length) {
    const wasSplit = layout.hasClass("horizontal-split");
    layout.toggleClass("horizontal-split", shouldSplit);
    if (wasSplit !== shouldSplit) {
      schedule_rosary_canvas_refresh();
    }
  }
  apply_line_by_line_mode(!shouldSplit, { triggerRender, allowAutoAdjust });
}

function schedule_rosary_canvas_refresh() {
  if (typeof window === "undefined" || !window.rosary) {
    return;
  }
  if (rosaryLayoutRefreshHandle) {
    cancelAnimationFrame(rosaryLayoutRefreshHandle);
  }
  rosaryLayoutRefreshHandle = requestAnimationFrame(() => {
    rosaryLayoutRefreshHandle = null;
    if (typeof window !== "undefined") {
      window.dispatchEvent(new Event("resize"));
    }
    if (window.rosary && typeof window.rosary.reset === "function") {
      window.rosary.reset();
    }
  });
}

function advance_prayer_line() {
  if (!lineByLineEnabled) {
    return;
  }
  if (!prayerSequence.length) {
    return;
  }
  const step = prayerSequence[prayerSequenceIndex];
  const lines = get_step_lines(step);
  if (prayerLineIndex < lines.length - 1) {
    prayerLineIndex += 1;
    render_prayer_step();
  }
}

function retreat_prayer_line() {
  if (!lineByLineEnabled) {
    return;
  }
  if (!prayerSequence.length) {
    return;
  }
  if (prayerLineIndex > 0) {
    prayerLineIndex -= 1;
    render_prayer_step();
  }
}

function advance_prayer_step() {
  if (!prayerSequence.length) {
    return;
  }
  if (prayerSequenceIndex < prayerSequence.length - 1) {
    prayerSequenceIndex += 1;
    prayerLineIndex = 0;
    render_prayer_step();
  }
}

function retreat_prayer_step() {
  if (!prayerSequence.length) {
    return;
  }
  if (prayerSequenceIndex > 0) {
    prayerSequenceIndex -= 1;
    prayerLineIndex = 0;
    render_prayer_step();
  }
}

function readSetting(key, defaultValue) {
  try {
    const raw = localStorage.getItem(settingsPrefix + key);
    if (raw === null) {
      return defaultValue;
    }
    return JSON.parse(raw);
  } catch (error) {
    console.warn("Failed to read setting", key, error);
    return defaultValue;
  }
}

function writeSetting(key, value) {
  try {
    localStorage.setItem(settingsPrefix + key, JSON.stringify(value));
  } catch (error) {
    console.warn("Failed to write setting", key, error);
  }
}

function select_default_mystery_for_today() {
  plannerMysteryControls.forEach(({ checkbox }) => {
    const element = $(checkbox);
    if (element.length) {
      element.prop("checked", false);
    }
  });

  const day = new Date().getDay();
  switch (day) {
    case 1: // Monday
    case 6: // Saturday
      $("#plannerJoyful").prop("checked", true);
      break;
    case 2: // Tuesday
    case 5: // Friday
      $("#plannerSorrowful").prop("checked", true);
      break;
    case 3: // Wednesday
    case 0: // Sunday
      $("#plannerGlorious").prop("checked", true);
      break;
    case 4: // Thursday
      $("#plannerLuminous").prop("checked", true);
      break;
    default:
      break;
  }
  update_mystery_count_states();
}

function update_planner_start_button() {
  const plannerCheckboxes = $(plannerCheckboxSelector);
  if (!plannerCheckboxes.length) {
    return;
  }
  const hasSelection = plannerCheckboxes.is(":checked");
  $("#plannerStartButton").prop("disabled", !hasSelection);
}

function update_mystery_count_states() {
  plannerMysteryControls.forEach(({ checkbox, select }) => {
    const checkboxElement = $(checkbox);
    const selectElement = $(select);
    if (!selectElement.length) {
      return;
    }
    const checked = checkboxElement.is(":checked");
    const wasDisabled = selectElement.prop("disabled");
    selectElement.prop("disabled", !checked);
    if (checked && wasDisabled) {
      selectElement.val("5");
    }
  });
}

function update_voice_auto_option() {
  const autoProgressCheckbox = $("#plannerOptionAutoProgress");
  const voiceAutoCheckbox = $("#plannerOptionVoiceAuto");
  if (!autoProgressCheckbox.length || !voiceAutoCheckbox.length) {
    return;
  }
  const enableVoiceAuto = autoProgressCheckbox.is(":checked");
  voiceAutoCheckbox.prop("disabled", !enableVoiceAuto);
  if (enableVoiceAuto) {
    voiceAutoCheckbox.prop("checked", voiceAutoPreference);
  } else {
    voiceAutoCheckbox.prop("checked", false);
  }
}

function load_option_settings() {
  const initialLineByLine = !should_use_horizontal_split();

  ttsEnabled = !!readSetting("option.tts", false);
  $("#plannerOptionTts").prop("checked", ttsEnabled);

  let autoStoredRaw = null;
  try {
    autoStoredRaw = localStorage.getItem(settingsPrefix + "option.autoProgress");
  } catch (error) {
    autoStoredRaw = null;
  }
  const autoPrefOriginal = !!readSetting("option.autoProgress", false);
  let autoPref = autoPrefOriginal;
  let persistAutoPref = false;
  if (autoStoredRaw === null && (initialLineByLine || ttsEnabled)) {
    autoPref = true;
    persistAutoPref = true;
  }
  if (ttsEnabled && !autoPref) {
    autoPref = true;
    persistAutoPref = true;
  }
  $("#plannerOptionAutoProgress").prop("checked", autoPref);
  autoProgressEnabled = autoPref;
  if (persistAutoPref && autoPref !== autoPrefOriginal) {
    writeSetting("option.autoProgress", autoPref);
  }

  voiceAutoPreference = !!readSetting("option.voiceAuto", false);

  apply_horizontal_split_layout({ triggerRender: false, allowAutoAdjust: false });

  const fullscreenPref = !!readSetting("option.fullscreen", false);
  if (document.fullscreenElement) {
    $("#plannerOptionFullscreen").prop("checked", true);
  } else {
    $("#plannerOptionFullscreen").prop("checked", fullscreenPref);
  }

  update_voice_auto_option();
  handle_tts_enabled_change();
}

function init_option_collapse_icon() {
  const optionsCollapse = $("#plannerOptions");
  const toggleIcon = $("#plannerOptionsToggleIcon");
  if (!optionsCollapse.length || !toggleIcon.length) {
    return;
  }
  optionsCollapse.on("show.bs.collapse", function() {
    toggleIcon.removeClass("bi-chevron-down").addClass("bi-chevron-up");
  });
  optionsCollapse.on("hide.bs.collapse", function() {
    toggleIcon.removeClass("bi-chevron-up").addClass("bi-chevron-down");
  });
}

function toggle_fullscreen(enabled) {
  if (enabled) {
    if (!document.fullscreenElement && document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen().catch(() => {
        $("#plannerOptionFullscreen").prop("checked", false);
        writeSetting("option.fullscreen", false);
      });
    }
  } else {
    if (document.fullscreenElement && document.exitFullscreen) {
      document.exitFullscreen().catch(() => {});
    }
  }
}

function sync_fullscreen_checkbox() {
  const checkbox = $("#plannerOptionFullscreen");
  if (!checkbox.length) {
    return;
  }
  checkbox.prop("checked", !!document.fullscreenElement);
  writeSetting("option.fullscreen", checkbox.is(":checked"));
  apply_horizontal_split_layout();
}

document.addEventListener("fullscreenchange", sync_fullscreen_checkbox);

function reset_option_collapse_state() {
  const optionsCollapseElement = document.getElementById("plannerOptions");
  if (!optionsCollapseElement) {
    return;
  }
  const collapseInstance = bootstrap.Collapse.getInstance(optionsCollapseElement);
  if (collapseInstance) {
    collapseInstance.hide();
  } else {
    $(optionsCollapseElement).removeClass("show");
  }
  $("#plannerOptionsToggleIcon").removeClass("bi-chevron-up").addClass("bi-chevron-down");
}

function set_prayer_options_toggle_state(expanded) {
  const toggleButton = $("#prayerOptionsToggleButton");
  if (!toggleButton.length) {
    return;
  }
  toggleButton.toggleClass("active", !!expanded);
  toggleButton.attr("aria-expanded", expanded ? "true" : "false");
  const caret = $("#prayerOptionsToggleCaret");
  if (caret.length) {
    caret.toggleClass("bi-chevron-down", !!expanded);
    caret.toggleClass("bi-chevron-up", !expanded);
  }
}

function open_prayer_options_overlay() {
  const overlay = $("#prayerOptionsOverlay");
  if (!overlay.length) {
    return;
  }
  overlay.removeClass("d-none").attr("aria-hidden", "false");
  set_prayer_options_toggle_state(true);
}

function close_prayer_options_overlay() {
  const overlay = $("#prayerOptionsOverlay");
  if (!overlay.length) {
    return;
  }
  overlay.addClass("d-none").attr("aria-hidden", "true");
  set_prayer_options_toggle_state(false);
}

function move_options_to_overlay() {
  const overlay = $("#prayerOptionsOverlay");
  const wrapper = $("#plannerOptionsWrapper");
  if (overlay.length && wrapper.length) {
    overlay.append(wrapper);
    $("#prayerViewOptions").removeClass("d-none");
    wrapper.addClass("prayer-overlay-active");
    const headerButton = wrapper.children("button[data-bs-toggle=\"collapse\"]");
    if (headerButton.length) {
      headerButton.addClass("d-none").attr("aria-hidden", "true");
    }
    const optionsCollapseElement = document.getElementById("plannerOptions");
    if (optionsCollapseElement) {
      let collapseInstance = bootstrap.Collapse.getInstance(optionsCollapseElement);
      if (!collapseInstance) {
        collapseInstance = new bootstrap.Collapse(optionsCollapseElement, { toggle: false });
      }
      collapseInstance.show();
    } else {
      $("#plannerOptions").addClass("show");
    }
    close_prayer_options_overlay();
  }
}

function move_options_to_planner() {
  const home = $("#plannerOptionsHome");
  const wrapper = $("#plannerOptionsWrapper");
  if (home.length && wrapper.length) {
    const optionsCollapseElement = document.getElementById("plannerOptions");
    if (optionsCollapseElement) {
      const collapseInstance = bootstrap.Collapse.getInstance(optionsCollapseElement);
      if (collapseInstance) {
        collapseInstance.hide();
      } else {
        $(optionsCollapseElement).removeClass("show");
      }
    } else {
      $("#plannerOptions").removeClass("show");
    }
    const headerButton = wrapper.children("button[data-bs-toggle=\"collapse\"]");
    if (headerButton.length) {
      headerButton.removeClass("d-none").removeAttr("aria-hidden");
    }
    $("#prayerViewOptions").addClass("d-none");
    wrapper.removeClass("prayer-overlay-active");
    home.append(wrapper);
    reset_option_collapse_state();
    close_prayer_options_overlay();
  }
}

function enter_prayer_view() {

  prayerSequence = build_prayer_sequence();
  prayerSequenceIndex = 0;
  prayerLineIndex = 0;
  render_prayer_step();
  move_options_to_overlay();
  const wantsFullscreen = !!readSetting("option.fullscreen", false);
  if (wantsFullscreen && !document.fullscreenElement) {
    toggle_fullscreen(true);
  } else {
    sync_fullscreen_checkbox();
  }
  $("body").addClass("prayer-mode");
  $("#mainNavbar, #mainFooter").addClass("d-none");
  $("#plannerView").addClass("d-none");
  $("#prayerView").removeClass("d-none");
  apply_horizontal_split_layout();
  const rosaryCanvasAPI = window.RosaryCanvas;
  if (!rosaryCanvasAPI || typeof rosaryCanvasAPI.create !== "function") {
    console.error("RosaryCanvas engine가 로드되지 않았습니다.");
    return;
  }
  window.rosary = rosaryCanvasAPI.create(document.getElementById('rosary-canvas'));
  window.rosary.reset();
  handle_tts_after_render();

}

function exit_prayer_view() {
  stop_tts({ cancelSpeech: true, resetKaraoke: true });
  prayerSequence = [];
  prayerSequenceIndex = 0;
  prayerLineIndex = 0;
  render_prayer_step();
  move_options_to_planner();
  $("body").removeClass("prayer-mode");
  $("#mainNavbar, #mainFooter").removeClass("d-none");
  $("#prayerView").addClass("d-none");
  $("#plannerView").removeClass("d-none");
  apply_horizontal_split_layout();
}

$(document).ready(function() {
  show_menu_title(false);
  select_default_mystery_for_today();
  init_tts_engine();
  load_option_settings();
  const plannerCheckboxes = $(plannerCheckboxSelector);
  plannerCheckboxes.on("change", function() {
    update_planner_start_button();
    update_mystery_count_states();
  });
  update_planner_start_button();
  update_mystery_count_states();
  $("#plannerOptionTts").on("change", function() {
    ttsEnabled = $(this).is(":checked");
    writeSetting("option.tts", ttsEnabled);
    apply_line_by_line_mode(lineByLineEnabled);
    handle_tts_enabled_change();
  });
  $("#plannerOptionAutoProgress").on("change", function() {
    const enabled = $(this).is(":checked");
    writeSetting("option.autoProgress", enabled);
    update_voice_auto_option();
    autoProgressEnabled = enabled;
  });
  $("#plannerOptionVoiceAuto").on("change", function() {
    voiceAutoPreference = $(this).is(":checked");
    writeSetting("option.voiceAuto", voiceAutoPreference);
  });
  init_option_collapse_icon();
  $("#plannerOptionFullscreen").on("change", function() {
    const enabled = $(this).is(":checked");
    writeSetting("option.fullscreen", enabled);
    toggle_fullscreen(enabled);
  });
  $("#plannerStartButton").on("click", enter_prayer_view);
  $("#prayerExitButton").on("click", exit_prayer_view);
  $("#prayerPrevButton").on("click", retreat_prayer_step);
  $("#prayerNextButton").on("click", advance_prayer_step);
  $("#prayerLinePrevButton").on("click", retreat_prayer_line);
  $("#prayerLineNextButton").on("click", advance_prayer_line);
  $("#rosaryLayoutResetButton").on("click", function() {
    if(window.rosary) {
      window.rosary.reset();
    }
  });
  $("#prayerOptionsToggleButton").on("click", function() {
    const overlay = $("#prayerOptionsOverlay");
    if (!overlay.length || !overlay.children().length) {
      return;
    }
    if (overlay.hasClass("d-none")) {
      open_prayer_options_overlay();
    } else {
      close_prayer_options_overlay();
    }
  });

  $(window).on("resize", function() {
    apply_horizontal_split_layout();
  });

  $(document).on("keydown", function(event) {
    if (!$("body").hasClass("prayer-mode")) {
      return;
    }
    const tag = event.target && event.target.tagName ? event.target.tagName.toLowerCase() : "";
    if (tag === "input" || tag === "textarea" || event.target.isContentEditable) {
      return;
    }
    let handled = false;
    switch (event.key) {
      case "ArrowLeft":
        retreat_prayer_step();
        handled = true;
        break;
      case "ArrowRight":
        advance_prayer_step();
        handled = true;
        break;
      case "ArrowUp":
        if (lineByLineEnabled) {
          retreat_prayer_line();
          handled = true;
        }
        break;
      case "ArrowDown":
        if (lineByLineEnabled) {
          advance_prayer_line();
          handled = true;
        }
        break;
      case "Enter":
        if (window.rosary && typeof window.rosary.reset === "function") {
          window.rosary.reset();
          handled = true;
        }
        break;
      default:
        break;
    }
    if (handled) {
      event.preventDefault();
    }
  });

  render_prayer_step();

  if(window.location.hash == "") {
    if(localStorage.getItem(startup_dialog_version) != "no") {
      $("#startupModal").modal("show");
    }
  }
});

</script>

</html>
