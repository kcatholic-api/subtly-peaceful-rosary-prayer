
<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="생각보다 은근히 평안한 묵주 기도 도우미">
    <!--<meta name="author" content="">-->
    <title>생각보다 은근히 평안한 묵주 기도 도우미</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="rosary-canvas.js"></script>

    <link rel="icon" href="favicon.ico">

    <style>
      .prayer-layout {
        display: grid;
        grid-template-rows: minmax(0, 8fr) minmax(140px, 2fr);
        min-height: calc(100vh - 160px);
        gap: 1rem;
      }
      .prayer-pane-bottom {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 0.75rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 140px;
      }
      .prayer-lyric-area {
        flex: 1 1 auto;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        text-align: center;
      }
      .prayer-step-title {
        text-align: left;
      }
      .prayer-step-body {
        flex: 1 1 auto;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .prayer-options-overlay {
        max-width: 320px;
      }
      .prayer-options-overlay #plannerOptionsWrapper {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: 1px solid #dee2e6;
      }
      .prayer-options-overlay #plannerOptions {
        border-top: none;
      }
      .prayer-options-toggle-button {
        background-color: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
        padding: 0.5rem 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        white-space: nowrap;
        font-weight: 600;
        color: #212529;
      }
      .prayer-options-toggle-button.active {
        border-color: rgba(13, 110, 253, 0.6);
        box-shadow: 0 0.5rem 1.5rem rgba(13, 110, 253, 0.15);
      }
      .prayer-options-toggle-button:focus-visible {
        outline: 2px solid rgba(13, 110, 253, 0.6);
        outline-offset: 2px;
      }
      #prayerOptionsOverlay .prayer-overlay-active .border-top {
        border-top-width: 0;
      }
      body.prayer-mode {
        overflow: hidden;
        height: 100dvh;
        min-height: 100dvh;
      }
      body.prayer-mode main.container-fluid {
        padding: 0;
        height: 100dvh;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
      }
      body.prayer-mode #plannerView {
        display: none !important;
      }
      body.prayer-mode #prayerView {
        flex: 1 1 auto;
        display: flex !important;
        flex-direction: column;
        position: fixed;
        inset: 0;
        padding: 1rem;
        height: auto;
        background-color: var(--bs-body-bg, #ffffff);
        overflow: hidden;
        z-index: 1000;
      }
      body.prayer-mode .prayer-layout {
        flex: 1 1 auto;
        min-height: 0;
        height: 100%;
        grid-template-rows: minmax(0, 8fr) minmax(140px, 2fr);
      }
      body.prayer-mode .prayer-pane-top {
        min-height: 0;
      }
      body.prayer-mode .prayer-pane-bottom {
        min-height: 140px;
      }
      body.prayer-mode #notice_div,
      body.prayer-mode #error_div,
      body.prayer-mode #mdrow {
        display: none !important;
      }
      @media (max-width: 767.98px) {
        .prayer-layout {
          min-height: 100%;
        }
        body.prayer-mode .prayer-layout {
          height: 100%;
          min-height: 100%;
        }
        .prayer-pane-top {
          min-height: 240px;
        }
        body.prayer-mode #prayerView {
          padding: 0.5rem;
          padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0px));
        }
      }
    </style>
  </head>
  <body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4" id="mainNavbar">
  <div class="container-fluid">
    <a class="navbar-brand" href="" id="menu_title">묵주 기도 도우미</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="#" onclick="load_record()">나의 기록</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- First Modal -->
<div class="modal fade" id="startupModal" tabindex="-1" aria-labelledby="startupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="startupModalLabel"><small><i>생각보다 은근히 평안한</i></small><br/>묵주 기도 도우미</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
        평화를 빕니다!
        </p>
        <p>
        이 웹사이트는 어려운 가톨릭 묵주 기도를 생각보다 편리하고 평안한 기분으로 시도해 볼 수 있는 기능을 제공하여 전 세계 한인 가톨릭 공동체의 형제자매님들께 도움이 되고자 만들어졌습니다.
        </p>
        <small>
        이 웹사이트는 <b>데스크톱</b> 브라우저 환경에 최적화되어 있습니다. 혹시! 모바일에서 열어보셨다면 <i>생각보다 은근히</i> 불편하실 수 있으니, 집에 돌아가신 후 컴퓨터로 다시 방문하시길 권해드립니다.
        </small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="never_see_startup()">다시 보지 않기</button>
      </div>
    </div>
  </div>
</div>

<!-- Load Modal -->
<div class="modal fade" id="loadModal" tabindex="-1" aria-labelledby="loadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="loadModalLabel">로컬 브라우저 저장소 불러오기</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <p>
          <small>어떻게 작동 하나요?</small> <a id="readMore3" data-bs-toggle="collapse" href="#moreText3" aria-expanded="false" aria-controls="moreText3"><small>자세히</small></a></small>
          <span id="moreText3" class="collapse"><br/><small>편집기로 작성 중인 Markdown 문서에서 Heading 1 (#) 또는 Heading 2 (##) 가 적용된 문자열을 추출해서 문서 제목으로 간주 합니다. 이 제목을 Key로 정하고 웹 표준 기술인 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API" target="_blank">Web Storage API</a>을 이용하여 전체 Markdown 데이타를 사용중인 디바이스의 웹브라우저에 저장하고 불러 옵니다. 따라서 서버에는 그 어떤 정보도 저장되지 않습니다.</small><br/>
          <small>로컬 브라우저 저장소는 어떤 이유에서건 사라질 수 있습니다. 작성하신 문서는 다운로드 기능을 사용하여 Markdown (확장자.md) 파일로 직접 안전하게 저장해 두시는 것을 권장합니다.</small></span>
        </p>
        <div class="list-group" id="saved">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid">
  <div class="row ms-1 me-1">
    <div id="notice_div" class="alert alert-primary" role="alert" style="display: none"></div>
    <div id="error_div" class="alert alert-danger" role="alert" style="display: none"></div>
  </div>
  <div id="plannerView">
    <div class="row justify-content-center mb-4">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="card-title text-center mb-4">오늘의 묵주 기도</h2>
            <p class="text-center text-secondary mb-2">오늘 함께 바칠 신비를 선택해 보세요.</p>
            <p class="text-center text-muted small mb-4">월·토 환희 | 화·금 고통 | 수·일 영광 | 목요일 빛의 신비</p>
            <div class="row gy-3">
              <div class="col-12 col-sm-6">
                <div class="form-check border rounded p-3 h-100 d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" value="환의의 신비" id="plannerJoyful">
                    <label class="form-check-label fw-semibold mb-0" for="plannerJoyful">
                      환의의 신비
                    </label>
                  </div>
                  <select class="form-select form-select-sm w-auto text-center" id="plannerJoyfulCount" aria-label="환의의 신비 단수 선택" disabled>
                    <option value="1">1단</option>
                    <option value="2">2단</option>
                    <option value="3">3단</option>
                    <option value="4">4단</option>
                    <option value="5" selected>5단</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="form-check border rounded p-3 h-100 d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" value="고통의 신비" id="plannerSorrowful">
                    <label class="form-check-label fw-semibold mb-0" for="plannerSorrowful">
                      고통의 신비
                    </label>
                  </div>
                  <select class="form-select form-select-sm w-auto text-center" id="plannerSorrowfulCount" aria-label="고통의 신비 단수 선택" disabled>
                    <option value="1">1단</option>
                    <option value="2">2단</option>
                    <option value="3">3단</option>
                    <option value="4">4단</option>
                    <option value="5" selected>5단</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="form-check border rounded p-3 h-100 d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" value="영광의 신비" id="plannerGlorious">
                    <label class="form-check-label fw-semibold mb-0" for="plannerGlorious">
                      영광의 신비
                    </label>
                  </div>
                  <select class="form-select form-select-sm w-auto text-center" id="plannerGloriousCount" aria-label="영광의 신비 단수 선택" disabled>
                    <option value="1">1단</option>
                    <option value="2">2단</option>
                    <option value="3">3단</option>
                    <option value="4">4단</option>
                    <option value="5" selected>5단</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="form-check border rounded p-3 h-100 d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" value="빛의 신비" id="plannerLuminous">
                    <label class="form-check-label fw-semibold mb-0" for="plannerLuminous">
                      빛의 신비
                    </label>
                  </div>
                  <select class="form-select form-select-sm w-auto text-center" id="plannerLuminousCount" aria-label="빛의 신비 단수 선택" disabled>
                    <option value="1">1단</option>
                    <option value="2">2단</option>
                    <option value="3">3단</option>
                    <option value="4">4단</option>
                    <option value="5" selected>5단</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mt-4" id="plannerOptionsHome">
              <div class="border rounded" id="plannerOptionsWrapper">
                <button class="w-100 bg-transparent border-0 px-3 py-3 d-flex align-items-center justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#plannerOptions" aria-expanded="false" aria-controls="plannerOptions">
                  <span class="fw-semibold">옵션</span>
                  <i class="bi bi-chevron-down" aria-hidden="true" id="plannerOptionsToggleIcon"></i>
                </button>
                <div class="collapse" id="plannerOptions">
                  <div class="border-top px-3 pb-3 pt-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" role="switch" id="plannerOptionTts">
                      <label class="form-check-label" for="plannerOptionTts">TTS로 읽어 주기</label>
                    </div>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="plannerOptionAutoProgress">
                    <label class="form-check-label" for="plannerOptionAutoProgress">자동으로 진행 하기</label>
                  </div>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="plannerOptionVoiceAuto" disabled>
                    <label class="form-check-label d-flex align-items-center" for="plannerOptionVoiceAuto">
                      음성 인식으로 자동 진행 하기
                      <span class="badge bg-secondary ms-2">실험 기능</span>
                    </label>
                  </div>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="plannerOptionFullscreen">
                    <label class="form-check-label" for="plannerOptionFullscreen">전체 화면으로 보기</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
            <div class="d-grid mt-4">
              <button type="button" class="btn btn-primary btn-lg py-3" id="plannerStartButton" disabled>시작</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="prayerView" class="d-none">
    <div class="prayer-layout">
      <div class="prayer-pane-top position-relative">
        <canvas id="rosary-canvas" style="width:100%;height:100%"></canvas>
        <div class="prayer-metadata position-absolute top-0 start-0 m-3">
          <div class="d-flex align-items-baseline flex-wrap gap-2">
            <h3 class="fw-bold mb-0" id="prayerCurrentMystery">환의의 신비</h3>
            <div class="fw-semibold fs-5 text-muted" id="prayerCurrentDecade">1단</div>
          </div>
          <div class="prayer-step-title w-100 mb-3">
            <p class="text-secondary fw-semibold mb-0" id="prayerCurrentStepTitle">이 영역은 추후 묵주 기도문을 표시하기 위한 자리입니다.</p>
          </div>
        </div>
        <button type="button" class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-0 m-3" id="prayerExitButton" aria-label="플래너로 돌아가기">
          <i class="bi bi-x-lg"></i>
        </button>
        <div class="position-absolute bottom-0 start-0 m-3 d-flex flex-column align-items-start gap-2">
          <div id="prayerOptionsOverlay" class="prayer-options-overlay d-none" aria-hidden="true"></div>
          <button type="button" class="btn prayer-options-toggle-button btn-sm d-inline-flex align-items-center gap-2" id="prayerOptionsToggleButton" aria-expanded="false" aria-controls="prayerOptionsOverlay">
            <span class="fw-semibold">옵션</span>
            <i class="bi bi-chevron-up" id="prayerOptionsToggleCaret" aria-hidden="true"></i>
          </button>
        </div>
        <div class="position-absolute bottom-0 end-0 m-3 d-flex align-items-center gap-2">
          <button type="button" class="btn btn-outline-secondary" id="prayerPrevButton">
            이전
          </button>
          <button type="button" class="btn btn-primary" id="prayerNextButton">
            다음
          </button>
        </div>
      </div>
      <div class="prayer-pane-bottom">
        <div class="prayer-lyric-area px-4 py-4">
          <div class="prayer-step-body w-100">
            <p class="lead fw-semibold mb-0 text-center w-100" id="prayerCurrentStepContent">기도문이 여기에 표시됩니다.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="mdrow" class="row">
  </div>
</main>
  <footer style="text-align: center" class="pt-2" id="mainFooter">
    <p class="fs-6"><small>평화를 빕니다! <a href="https://kcatholic-api.github.io/" target="_blank">한국어 가톨릭 API 프로젝트</a>를 방문하여 보세요.</small></p>
  </footer>
  </body>

<script>
function show_catch_phrase() {
  $("#menu_title").text("생각보다 은근히 평안한").fadeIn(500).delay(5000).fadeOut(500, show_menu_title);
}
function show_menu_title(fade=true) {
  if(fade)
    $("#menu_title").text("묵주 기도 도우미").fadeIn(500).delay(25000).fadeOut(500, show_catch_phrase);
  else
    $("#menu_title").text("묵주 기도 도우미").delay(25000).fadeOut(500, show_catch_phrase);
}

var startup_dialog_version = "kcatolic-api-sprp-startup-message-v1";
function never_see_startup() {
  localStorage.setItem(startup_dialog_version, "no");
}

function load_record() {
}

const plannerMysteryControls = [
  { checkbox: "#plannerJoyful", select: "#plannerJoyfulCount" },
  { checkbox: "#plannerSorrowful", select: "#plannerSorrowfulCount" },
  { checkbox: "#plannerGlorious", select: "#plannerGloriousCount" },
  { checkbox: "#plannerLuminous", select: "#plannerLuminousCount" }
];
const plannerCheckboxSelector = plannerMysteryControls.map((control) => control.checkbox).join(", ");
const settingsPrefix = "kcatolic-api-sprp-settings.";
let voiceAutoPreference = false;
let prayerSequence = [];
let prayerSequenceIndex = 0;
let prayerStepIdCounter = 0;

const rosaryPrayerTexts = {
  apostlesCreed: "전능하신 천주 성부, 천지의 창조주를 저는 믿나이다.\n그 외아들 우리 주 예수 그리스도님,\n성령으로 인하여 동정 마리아께 잉태되어 나시고,\n본시오 빌라도 통치 아래에서 고난을 받으시고,\n십자가에 못 박혀 돌아가시고 묻히셨으며,\n저승에 가시어 사흗날에 죽은 이들 가운데서 부활하시고,\n하늘에 올라 전능하신 천주 성부 오른편에 앉아 계시며,\n그리로부터 산 이와 죽은 이를 심판하러 오시리라 믿나이다.\n성령을 믿으며,\n거룩하고 보편된 교회와 모든 성인의 통공을 믿으며,\n죄의 용서와 육신의 부활을 믿으며,\n영원한 삶을 믿나이다. 아멘.",
  ourFather: "하늘에 계신 우리 아버지,\n아버지의 이름이 거룩히 빛나시며\n아버지의 나라가 오시며\n아버지의 뜻이 하늘에서와 같이 땅에서도 이루어지소서.\n오늘 저희에게 일용할 양식을 주시고\n저희에게 잘못한 이를 저희가 용서하오니\n저희 죄를 용서하시고\n저희를 유혹에 빠지지 않게 하시고\n악에서 구하소서. 아멘.",
  hailMary: "은총이 가득하신 마리아님, 기뻐하소서.\n주님께서 함께 계시니 여인 중에 복되시며\n태중의 아들 예수님 또한 복되시나이다.\n천주의 성모 마리아님,\n이제와 저희 죽을 때에 저희 죄인을 위하여 빌어주소서. 아멘.",
  gloryBe: "영광이 성부와 성자와 성령께,\n처음과 같이 이제와 항상 영원히. 아멘.",
  fatimaPrayer: "오 나의 예수님,\n우리의 죄를 용서하시며 우리를 지옥 불에서 구하시고,\n연옥 영혼을 돌보시며 가장 버림받은 영혼을 돌보소서. 아멘.",
  hailHolyQueen: "천상 모후, 사랑이 불타는 어머니,\n우리의 생명, 기쁨, 희망이시여!\n당신 우러러 하와의 그 자손들,\n눈물의 골짜기에서 통곡하며 부르짖나이다.\n우리들의 보호자 성모님,\n불쌍한 저희를 인자로운 눈으로 굽어보소서.\n귀양살이 끝날 때에 당신의 지극히 사랑하올\n아들 예수를 저희에게 보이소서.\n너그러우시고, 자애로우시며,\n오 아름다우신 동정 마리아님.\n천주의 성모님,\n저희를 위하여 빌어주시어\n그리스도께서 약속하신 영원한 생명을 얻게 하소서. 아멘."
};

const rosaryMysteryData = {
  "#plannerJoyful": {
    key: "joyful",
    title: "환의의 신비",
    decades: [
      { label: "1단", meditation: "마리아께서 예수님을 잉태하심을 묵상합시다." },
      { label: "2단", meditation: "마리아께서 엘리사벳을 찾아가 도와드림을 묵상합시다." },
      { label: "3단", meditation: "예수님께서 탄생하심을 묵상합시다." },
      { label: "4단", meditation: "마리아와 요셉이 예수님을 성전에 봉헌함을 묵상합시다." },
      { label: "5단", meditation: "예수님께서 성전에서 율법 학자들과 토론하심을 묵상합시다." }
    ]
  },
  "#plannerSorrowful": {
    key: "sorrowful",
    title: "고통의 신비",
    decades: [
      { label: "1단", meditation: "예수님께서 우리를 위하여 피땀 흘리심을 묵상합시다." },
      { label: "2단", meditation: "예수님께서 우리를 위하여 매맞으심을 묵상합시다." },
      { label: "3단", meditation: "예수님께서 우리를 위하여 가시관 쓰심을 묵상합시다." },
      { label: "4단", meditation: "예수님께서 우리를 위하여 십자가를 지심을 묵상합시다." },
      { label: "5단", meditation: "예수님께서 우리를 위하여 십자가 위에서 돌아가심을 묵상합시다." }
    ]
  },
  "#plannerGlorious": {
    key: "glorious",
    title: "영광의 신비",
    decades: [
      { label: "1단", meditation: "예수님께서 부활하심을 묵상합시다." },
      { label: "2단", meditation: "예수님께서 승천하심을 묵상합시다." },
      { label: "3단", meditation: "성령께서 강림하심을 묵상합시다." },
      { label: "4단", meditation: "마리아께서 하늘에 올림을 받으심을 묵상합시다." },
      { label: "5단", meditation: "마리아께서 하늘의 모후로 관을 쓰심을 묵상합시다." }
    ]
  },
  "#plannerLuminous": {
    key: "luminous",
    title: "빛의 신비",
    decades: [
      { label: "1단", meditation: "예수님께서 세례를 받으심을 묵상합시다." },
      { label: "2단", meditation: "예수님께서 가나의 혼인 잔치를 통해 첫 기적을 베푸심을 묵상합시다." },
      { label: "3단", meditation: "예수님께서 하느님 나라를 선포하심을 묵상합시다." },
      { label: "4단", meditation: "예수님께서 거룩하게 변모하심을 묵상합시다." },
      { label: "5단", meditation: "예수님께서 성체 성사를 제정하심을 묵상합시다." }
    ]
  }
};

function create_intro_steps() {
  return [
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "준비",
      content: "성호경 및 십자가의 예수님 발에 입맞춤",
      highlight: 'none'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "사도신경",
      content: rosaryPrayerTexts.apostlesCreed,
      highlight: 'cross'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "주님의 기도",
      content: rosaryPrayerTexts.ourFather,
      highlight: 'intro-0'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "성모송 (1/3)",
      content: rosaryPrayerTexts.hailMary,
      highlight: 'intro-1'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "성모송 (2/3)",
      content: rosaryPrayerTexts.hailMary,
      highlight: 'intro-2'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "성모송 (3/3)",
      content: rosaryPrayerTexts.hailMary,
      highlight: 'intro-3'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "영광송",
      content: rosaryPrayerTexts.gloryBe,
      highlight: 'intro-4'
    },
    {
      type: "intro",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "구원을 위한 기도",
      content: rosaryPrayerTexts.fatimaPrayer,
      highlight: 'intro-4'
    }
  ];
}

function create_concluding_steps() {
  return [
    {
      type: "conclusion",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "성모찬송",
      content: rosaryPrayerTexts.hailHolyQueen,
      highlight: 'medal'
    },
    {
      type: "conclusion",
      mysteryTitle: "묵주 기도",
      decadeLabel: "",
      title: "마무리",
      content: "성호경 및 십자가의 예수님 발에 입맞춤",
      highlight: 'none'
    }
  ];
}

function create_decade_steps({ mysteryTitle, decadeLabel, meditation, hailMaryCount }) {
  const steps = [];
  steps.push({
    type: "meditation",
    mysteryTitle,
    decadeLabel,
    title: `${decadeLabel} 묵상`,
    content: meditation,
    highlight: 'none'
  });
  steps.push({
    type: "prayer",
    mysteryTitle,
    decadeLabel,
    title: "주님의 기도",
    content: rosaryPrayerTexts.ourFather,
    highlight: 'none'
  });
  for (let i = 1; i <= hailMaryCount; i += 1) {
    steps.push({
      type: "prayer",
      mysteryTitle,
      decadeLabel,
      title: "성모송",
      content: rosaryPrayerTexts.hailMary,
      highlight: 'none',
      progressLabel: `${i}/${hailMaryCount}`
    });
  }
  steps.push({
    type: "prayer",
    mysteryTitle,
    decadeLabel,
    title: "영광송",
    content: rosaryPrayerTexts.gloryBe,
    highlight: 'none'
  });
  steps.push({
    type: "prayer",
    mysteryTitle,
    decadeLabel,
    title: "구원의 기도",
    content: rosaryPrayerTexts.fatimaPrayer,
    highlight: 'none'
  });
  return steps;
}

function build_prayer_sequence() {
  prayerStepIdCounter = 0;
  const sequence = create_intro_steps();
  plannerMysteryControls.forEach(({ checkbox, select }) => {
    const checkboxElement = $(checkbox);
    const selectElement = $(select);
    const data = rosaryMysteryData[checkbox];
    if (!checkboxElement.length || !checkboxElement.is(":checked") || !data) {
      return;
    }
    const requestedCount = parseInt(selectElement.val(), 10) || data.decades.length;
    const effectiveCount = Math.min(requestedCount, data.decades.length);
    for (let index = 0; index < effectiveCount; index += 1) {
      const decade = data.decades[index];
      sequence.push(...create_decade_steps({
        mysteryTitle: data.title,
        decadeLabel: decade.label,
        meditation: decade.meditation,
        hailMaryCount: 10
      }));
    }
  });
  sequence.push(...create_concluding_steps());
  return sequence.map((step) => {
    prayerStepIdCounter += 1;
    const prefix = step.type || "step";
    return {
      ...step,
      stepId: `${prefix}-${prayerStepIdCounter}`
    };
  });
}

function render_prayer_navigation_state() {
  const hasSequence = prayerSequence.length > 0;
  const hasNext = prayerSequenceIndex < prayerSequence.length - 1;
  const hasPrev = prayerSequenceIndex > 0;
  const nextButton = $("#prayerNextButton");
  const prevButton = $("#prayerPrevButton");
  if (nextButton.length) {
    if (!hasSequence) {
      nextButton.prop("disabled", true).text("다음");
    } else if (hasNext) {
      nextButton.prop("disabled", false).text("다음");
    } else {
      nextButton.prop("disabled", true).text("완료");
    }
  }
  if (prevButton.length) {
    if (!hasSequence || !hasPrev) {
      prevButton.prop("disabled", true);
    } else {
      prevButton.prop("disabled", false);
    }
  }
}

function render_prayer_step() {
  if (!prayerSequence.length) {
    $("#prayerCurrentMystery").text("묵주 기도");
    $("#prayerCurrentDecade").text("");
    $("#prayerCurrentStepTitle").text("기도문");
    $("#prayerCurrentStepContent").text("묵주 기도를 시작하려면 단수를 선택해 주세요.");
    render_prayer_navigation_state();
    return;
  }
  const step = prayerSequence[prayerSequenceIndex];
  $("#prayerCurrentMystery").text(step.mysteryTitle || "묵주 기도");
  $("#prayerCurrentDecade").text(step.decadeLabel || "");
  const titleText = step.progressLabel ? `${step.title} (${step.progressLabel})` : step.title;
  $("#prayerCurrentStepTitle").text(titleText);
  $("#prayerCurrentStepContent").html(step.content.replace(/\n/g, "<br>"));
  if (step.stepId) {
    console.log(`step = ${step.stepId}`);
    if(window.app)
      window.app.highlight_rosary_step(step.highlight || 'none');
  }
  render_prayer_navigation_state();
}

function advance_prayer_step() {
  if (!prayerSequence.length) {
    return;
  }
  if (prayerSequenceIndex < prayerSequence.length - 1) {
    prayerSequenceIndex += 1;
    render_prayer_step();
  }
}

function retreat_prayer_step() {
  if (!prayerSequence.length) {
    return;
  }
  if (prayerSequenceIndex > 0) {
    prayerSequenceIndex -= 1;
    render_prayer_step();
  }
}

function readSetting(key, defaultValue) {
  try {
    const raw = localStorage.getItem(settingsPrefix + key);
    if (raw === null) {
      return defaultValue;
    }
    return JSON.parse(raw);
  } catch (error) {
    console.warn("Failed to read setting", key, error);
    return defaultValue;
  }
}

function writeSetting(key, value) {
  try {
    localStorage.setItem(settingsPrefix + key, JSON.stringify(value));
  } catch (error) {
    console.warn("Failed to write setting", key, error);
  }
}

function select_default_mystery_for_today() {
  plannerMysteryControls.forEach(({ checkbox }) => {
    const element = $(checkbox);
    if (element.length) {
      element.prop("checked", false);
    }
  });

  const day = new Date().getDay();
  switch (day) {
    case 1: // Monday
    case 6: // Saturday
      $("#plannerJoyful").prop("checked", true);
      break;
    case 2: // Tuesday
    case 5: // Friday
      $("#plannerSorrowful").prop("checked", true);
      break;
    case 3: // Wednesday
    case 0: // Sunday
      $("#plannerGlorious").prop("checked", true);
      break;
    case 4: // Thursday
      $("#plannerLuminous").prop("checked", true);
      break;
    default:
      break;
  }
  update_mystery_count_states();
}

function update_planner_start_button() {
  const plannerCheckboxes = $(plannerCheckboxSelector);
  if (!plannerCheckboxes.length) {
    return;
  }
  const hasSelection = plannerCheckboxes.is(":checked");
  $("#plannerStartButton").prop("disabled", !hasSelection);
}

function update_mystery_count_states() {
  plannerMysteryControls.forEach(({ checkbox, select }) => {
    const checkboxElement = $(checkbox);
    const selectElement = $(select);
    if (!selectElement.length) {
      return;
    }
    const checked = checkboxElement.is(":checked");
    const wasDisabled = selectElement.prop("disabled");
    selectElement.prop("disabled", !checked);
    if (checked && wasDisabled) {
      selectElement.val("5");
    }
  });
}

function update_voice_auto_option() {
  const autoProgressCheckbox = $("#plannerOptionAutoProgress");
  const voiceAutoCheckbox = $("#plannerOptionVoiceAuto");
  if (!autoProgressCheckbox.length || !voiceAutoCheckbox.length) {
    return;
  }
  const enableVoiceAuto = autoProgressCheckbox.is(":checked");
  voiceAutoCheckbox.prop("disabled", !enableVoiceAuto);
  if (enableVoiceAuto) {
    voiceAutoCheckbox.prop("checked", voiceAutoPreference);
  } else {
    voiceAutoCheckbox.prop("checked", false);
  }
}

function load_option_settings() {
  const ttsPref = !!readSetting("option.tts", false);
  $("#plannerOptionTts").prop("checked", ttsPref);

  const autoPref = !!readSetting("option.autoProgress", false);
  $("#plannerOptionAutoProgress").prop("checked", autoPref);

  voiceAutoPreference = !!readSetting("option.voiceAuto", false);

  const fullscreenPref = !!readSetting("option.fullscreen", false);
  if (document.fullscreenElement) {
    $("#plannerOptionFullscreen").prop("checked", true);
  } else {
    $("#plannerOptionFullscreen").prop("checked", fullscreenPref);
  }

  update_voice_auto_option();
}

function init_option_collapse_icon() {
  const optionsCollapse = $("#plannerOptions");
  const toggleIcon = $("#plannerOptionsToggleIcon");
  if (!optionsCollapse.length || !toggleIcon.length) {
    return;
  }
  optionsCollapse.on("show.bs.collapse", function() {
    toggleIcon.removeClass("bi-chevron-down").addClass("bi-chevron-up");
  });
  optionsCollapse.on("hide.bs.collapse", function() {
    toggleIcon.removeClass("bi-chevron-up").addClass("bi-chevron-down");
  });
}

function toggle_fullscreen(enabled) {
  if (enabled) {
    if (!document.fullscreenElement && document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen().catch(() => {
        $("#plannerOptionFullscreen").prop("checked", false);
        writeSetting("option.fullscreen", false);
      });
    }
  } else {
    if (document.fullscreenElement && document.exitFullscreen) {
      document.exitFullscreen().catch(() => {});
    }
  }
}

function sync_fullscreen_checkbox() {
  const checkbox = $("#plannerOptionFullscreen");
  if (!checkbox.length) {
    return;
  }
  checkbox.prop("checked", !!document.fullscreenElement);
  writeSetting("option.fullscreen", checkbox.is(":checked"));
}

document.addEventListener("fullscreenchange", sync_fullscreen_checkbox);

function reset_option_collapse_state() {
  const optionsCollapseElement = document.getElementById("plannerOptions");
  if (!optionsCollapseElement) {
    return;
  }
  const collapseInstance = bootstrap.Collapse.getInstance(optionsCollapseElement);
  if (collapseInstance) {
    collapseInstance.hide();
  } else {
    $(optionsCollapseElement).removeClass("show");
  }
  $("#plannerOptionsToggleIcon").removeClass("bi-chevron-up").addClass("bi-chevron-down");
}

function set_prayer_options_toggle_state(expanded) {
  const toggleButton = $("#prayerOptionsToggleButton");
  if (!toggleButton.length) {
    return;
  }
  toggleButton.toggleClass("active", !!expanded);
  toggleButton.attr("aria-expanded", expanded ? "true" : "false");
  const caret = $("#prayerOptionsToggleCaret");
  if (caret.length) {
    caret.toggleClass("bi-chevron-down", !!expanded);
    caret.toggleClass("bi-chevron-up", !expanded);
  }
}

function open_prayer_options_overlay() {
  const overlay = $("#prayerOptionsOverlay");
  if (!overlay.length) {
    return;
  }
  overlay.removeClass("d-none").attr("aria-hidden", "false");
  set_prayer_options_toggle_state(true);
}

function close_prayer_options_overlay() {
  const overlay = $("#prayerOptionsOverlay");
  if (!overlay.length) {
    return;
  }
  overlay.addClass("d-none").attr("aria-hidden", "true");
  set_prayer_options_toggle_state(false);
}

function move_options_to_overlay() {
  const overlay = $("#prayerOptionsOverlay");
  const wrapper = $("#plannerOptionsWrapper");
  if (overlay.length && wrapper.length) {
    overlay.append(wrapper);
    wrapper.addClass("prayer-overlay-active");
    const headerButton = wrapper.children("button[data-bs-toggle=\"collapse\"]");
    if (headerButton.length) {
      headerButton.addClass("d-none").attr("aria-hidden", "true");
    }
    const optionsCollapseElement = document.getElementById("plannerOptions");
    if (optionsCollapseElement) {
      let collapseInstance = bootstrap.Collapse.getInstance(optionsCollapseElement);
      if (!collapseInstance) {
        collapseInstance = new bootstrap.Collapse(optionsCollapseElement, { toggle: false });
      }
      collapseInstance.show();
    } else {
      $("#plannerOptions").addClass("show");
    }
    close_prayer_options_overlay();
  }
}

function move_options_to_planner() {
  const home = $("#plannerOptionsHome");
  const wrapper = $("#plannerOptionsWrapper");
  if (home.length && wrapper.length) {
    const optionsCollapseElement = document.getElementById("plannerOptions");
    if (optionsCollapseElement) {
      const collapseInstance = bootstrap.Collapse.getInstance(optionsCollapseElement);
      if (collapseInstance) {
        collapseInstance.hide();
      } else {
        $(optionsCollapseElement).removeClass("show");
      }
    } else {
      $("#plannerOptions").removeClass("show");
    }
    const headerButton = wrapper.children("button[data-bs-toggle=\"collapse\"]");
    if (headerButton.length) {
      headerButton.removeClass("d-none").removeAttr("aria-hidden");
    }
    wrapper.removeClass("prayer-overlay-active");
    home.append(wrapper);
    reset_option_collapse_state();
    close_prayer_options_overlay();
  }
}

function enter_prayer_view() {

  prayerSequence = build_prayer_sequence();
  prayerSequenceIndex = 0;
  render_prayer_step();
  move_options_to_overlay();
  const wantsFullscreen = !!readSetting("option.fullscreen", false);
  if (wantsFullscreen && !document.fullscreenElement) {
    toggle_fullscreen(true);
  } else {
    sync_fullscreen_checkbox();
  }
  $("body").addClass("prayer-mode");
  $("#mainNavbar, #mainFooter").addClass("d-none");
  $("#plannerView").addClass("d-none");
  $("#prayerView").removeClass("d-none");
  window.app = RosaryCanvas.create(document.getElementById('rosary-canvas'));
  window.app.reset();

}

function exit_prayer_view() {
  prayerSequence = [];
  prayerSequenceIndex = 0;
  render_prayer_step();
  move_options_to_planner();
  $("body").removeClass("prayer-mode");
  $("#mainNavbar, #mainFooter").removeClass("d-none");
  $("#prayerView").addClass("d-none");
  $("#plannerView").removeClass("d-none");
}

$(document).ready(function() {
  show_menu_title(false);
  select_default_mystery_for_today();
  load_option_settings();
  const plannerCheckboxes = $(plannerCheckboxSelector);
  plannerCheckboxes.on("change", function() {
    update_planner_start_button();
    update_mystery_count_states();
  });
  update_planner_start_button();
  update_mystery_count_states();
  $("#plannerOptionTts").on("change", function() {
    writeSetting("option.tts", $(this).is(":checked"));
  });
  $("#plannerOptionAutoProgress").on("change", function() {
    const enabled = $(this).is(":checked");
    writeSetting("option.autoProgress", enabled);
    update_voice_auto_option();
  });
  $("#plannerOptionVoiceAuto").on("change", function() {
    voiceAutoPreference = $(this).is(":checked");
    writeSetting("option.voiceAuto", voiceAutoPreference);
  });
  init_option_collapse_icon();
  $("#plannerOptionFullscreen").on("change", function() {
    const enabled = $(this).is(":checked");
    writeSetting("option.fullscreen", enabled);
    toggle_fullscreen(enabled);
  });
  $("#plannerStartButton").on("click", enter_prayer_view);
  $("#prayerExitButton").on("click", exit_prayer_view);
  $("#prayerPrevButton").on("click", retreat_prayer_step);
  $("#prayerNextButton").on("click", advance_prayer_step);
  $("#prayerOptionsToggleButton").on("click", function() {
    const overlay = $("#prayerOptionsOverlay");
    if (!overlay.length || !overlay.children().length) {
      return;
    }
    if (overlay.hasClass("d-none")) {
      open_prayer_options_overlay();
    } else {
      close_prayer_options_overlay();
    }
  });

  render_prayer_step();

  if(window.location.hash == "") {
    if(localStorage.getItem(startup_dialog_version) != "no") {
      console.log("show startup");
      $("#startupModal").modal("show");
    }
  }
});

</script>

</html>
